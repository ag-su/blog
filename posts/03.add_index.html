<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="agsu">
<meta name="dcterms.date" content="2022-07-09">

<title>Data Analysis blog - [stock prediction] 2.1 주가 데이터셋 보조지표 추가</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Data Analysis blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ag-su"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://agsu.tistory.com/"><i class="bi bi-box2-heart" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">[stock prediction] 2.1 주가 데이터셋 보조지표 추가</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">project</div>
                <div class="quarto-category">stock prediction</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>agsu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 9, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="data-preprocessing" class="level1">
<h1>2. Data Preprocessing</h1>
<section id="주가-데이터셋-보조지표-추가" class="level2">
<h2 class="anchored" data-anchor-id="주가-데이터셋-보조지표-추가">2.1. 주가 데이터셋 보조지표 추가</h2>
<p>이전 글 <a href="https://ag-su.github.io/blog/posts/02.model_selection.html">[Stock Research] 1.2. 머신러닝 모델 비교</a>까지 주가 데이터셋 생성과 머신러닝 모델 비교를 통해 baseline model을 생성했다. 이번 글 부터는 데이터 전처리를 진행한다. 모델을 이전 글에서 선택했던 baseline 모델로 fix하고, 데이터의 질을 높임으로써 성능을 향상시킨다. 그 첫번째로 주가데이터셋에 보조지표를 추가하여 설명변수의 크기를 늘린다.</p>
<section id="목차" class="level3">
<h3 class="anchored" data-anchor-id="목차">목차</h3>
<ul>
<li><ol type="1">
<li>주식 데이터의 보조지표</li>
</ol></li>
<li><ol start="2" type="1">
<li>보조지표 추가<br>
</li>
</ol></li>
<li><ol start="3" type="1">
<li>모델 학습</li>
</ol></li>
</ul>
<p><br></p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> FinanceDataReader <span class="im">as</span> fdr</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymysql</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ta</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ipywidgets <span class="im">import</span> interact, interact_manual</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.offline <span class="im">as</span> pyo</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pylab inline</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>pylab.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>%pylab is deprecated, use %matplotlib inline and import the required libraries.
Populating the interactive namespace from numpy and matplotlib</code></pre>
</div>
</div>
<p><br> <br></p>
</section>
</section>
<section id="주식데이터의-보조지표" class="level2">
<h2 class="anchored" data-anchor-id="주식데이터의-보조지표">(1) 주식데이터의 보조지표</h2>
<p>주식데이터에서 보조지표란 기술적지표라고도 불리며, 다양한 각도와 계산식, 통계 등을 바탕으로 기본적 분석 방법들과 조합하여 보다 폭 넓은 시장 예측을 가능하게 도와주는 차트 분석 도구이다.</p>
<p>[참고]<br>
-<a href="https://www.nanumtrading.com/fx-%eb%b0%b0%ec%9a%b0%ea%b8%b0/%ec%b0%a8%ed%8a%b8-%eb%b3%b4%ec%a1%b0%ec%a7%80%ed%91%9c-%ec%9d%b4%ed%95%b4/01-%eb%b3%b4%ec%a1%b0%ec%a7%80%ed%91%9c%eb%9e%80/">01 보조지표란?</a></p>
<p>그 중에서도, 주식 시장에서 많이 알려져 있고, 주가 예측에 자주 사용되는 보조지표로는 이동평균선을 예로 들어 확인해보겠다. 이동평균선을 캔들차트와 함께 시각화 하고, 각 종목과 날짜에 대해 어떻게 나타나는지 직접 확인한다.</p>
<ul>
<li><strong>데이터 불러오기</strong></li>
</ul>
<p><code>2018-01-01 ~ 2020-12-31</code> 기간 동안의 모든 데이터를 미리 저장해 놓은 주가 데이터셋을 불러온다.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df_stock <span class="op">=</span> pd.read_csv(<span class="st">"stock_data_2018_2020.csv"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df_stock[<span class="st">'Code'</span>] <span class="op">=</span> df_stock[<span class="st">'Code'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x : <span class="bu">str</span>(x).zfill(<span class="dv">6</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df_stock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Code</th>
      <th>Date</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Change</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>050120</td>
      <td>2018-01-02</td>
      <td>10250</td>
      <td>12050</td>
      <td>10150</td>
      <td>11800</td>
      <td>26086769</td>
      <td>0.145631</td>
    </tr>
    <tr>
      <th>1</th>
      <td>050120</td>
      <td>2018-01-03</td>
      <td>11950</td>
      <td>12450</td>
      <td>10900</td>
      <td>11750</td>
      <td>20460474</td>
      <td>-0.004237</td>
    </tr>
    <tr>
      <th>2</th>
      <td>050120</td>
      <td>2018-01-04</td>
      <td>11850</td>
      <td>14150</td>
      <td>11600</td>
      <td>12600</td>
      <td>60663854</td>
      <td>0.072340</td>
    </tr>
    <tr>
      <th>3</th>
      <td>050120</td>
      <td>2018-01-05</td>
      <td>12800</td>
      <td>13200</td>
      <td>12000</td>
      <td>12200</td>
      <td>13935258</td>
      <td>-0.031746</td>
    </tr>
    <tr>
      <th>4</th>
      <td>050120</td>
      <td>2018-01-08</td>
      <td>12450</td>
      <td>13400</td>
      <td>12350</td>
      <td>12850</td>
      <td>16471707</td>
      <td>0.053279</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1152013</th>
      <td>000540</td>
      <td>2020-12-23</td>
      <td>2880</td>
      <td>2945</td>
      <td>2835</td>
      <td>2870</td>
      <td>87318</td>
      <td>-0.010345</td>
    </tr>
    <tr>
      <th>1152014</th>
      <td>000540</td>
      <td>2020-12-24</td>
      <td>2850</td>
      <td>2875</td>
      <td>2845</td>
      <td>2860</td>
      <td>28350</td>
      <td>-0.003484</td>
    </tr>
    <tr>
      <th>1152015</th>
      <td>000540</td>
      <td>2020-12-28</td>
      <td>2860</td>
      <td>3000</td>
      <td>2805</td>
      <td>2820</td>
      <td>66036</td>
      <td>-0.013986</td>
    </tr>
    <tr>
      <th>1152016</th>
      <td>000540</td>
      <td>2020-12-29</td>
      <td>2820</td>
      <td>2920</td>
      <td>2705</td>
      <td>2775</td>
      <td>83187</td>
      <td>-0.015957</td>
    </tr>
    <tr>
      <th>1152017</th>
      <td>000540</td>
      <td>2020-12-30</td>
      <td>2835</td>
      <td>2835</td>
      <td>2755</td>
      <td>2830</td>
      <td>33270</td>
      <td>0.019820</td>
    </tr>
  </tbody>
</table>
<p>1152018 rows × 8 columns</p>
</div>
</div>
</div>
<ul>
<li><strong>이동평균선 캔들차트 시각화</strong></li>
</ul>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>IF <span class="op">=</span> <span class="bu">open</span>(<span class="st">'../data/code_list.txt'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>lst_code <span class="op">=</span> IF.readlines()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, code <span class="kw">in</span> <span class="bu">enumerate</span>(lst_code):</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    lst_code[idx] <span class="op">=</span> code.strip()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">@interact</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_label_dist(code <span class="op">=</span> lst_code):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df_stock[df_stock[<span class="st">'Code'</span>]<span class="op">==</span>code]    </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    ma_ls <span class="op">=</span> [<span class="dv">5</span>, <span class="dv">20</span>, <span class="dv">60</span>, <span class="dv">120</span>]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(ma_ls)):</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        sr1 <span class="op">=</span> df[<span class="st">'Close'</span>].rolling(window<span class="op">=</span>ma_ls[i]).mean()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'MA'</span><span class="op">+</span><span class="bu">str</span>(ma_ls[i])] <span class="op">=</span> sr1</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 캔들 차트 </span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    candle <span class="op">=</span> go.Candlestick(x<span class="op">=</span>df[<span class="st">'Date'</span>],</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                <span class="bu">open</span><span class="op">=</span>df[<span class="st">'Open'</span>],</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                high<span class="op">=</span>df[<span class="st">'High'</span>],</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                low<span class="op">=</span>df[<span class="st">'Low'</span>],</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                close<span class="op">=</span>df[<span class="st">'Close'</span>], increasing_line_color<span class="op">=</span> <span class="st">'red'</span>, decreasing_line_color<span class="op">=</span> <span class="st">'blue'</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 이동평균선</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    line_ma5 <span class="op">=</span> go.Scatter(x<span class="op">=</span>df[<span class="st">'Date'</span>], y<span class="op">=</span>df[<span class="st">'MA5'</span>], mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'MA5'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'magenta'</span>, width<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    line_ma20 <span class="op">=</span> go.Scatter(x<span class="op">=</span>df[<span class="st">'Date'</span>], y<span class="op">=</span>df[<span class="st">'MA20'</span>], mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'MA20'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>, width<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    line_ma60 <span class="op">=</span> go.Scatter(x<span class="op">=</span>df[<span class="st">'Date'</span>], y<span class="op">=</span>df[<span class="st">'MA60'</span>], mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'MA60'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'green'</span>, width<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    line_ma120 <span class="op">=</span> go.Scatter(x<span class="op">=</span>df[<span class="st">'Date'</span>], y<span class="op">=</span>df[<span class="st">'MA120'</span>], mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'MA120'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>, width<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 제목 추가</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    layout <span class="op">=</span> go.Layout(title<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st"> 캔들차트'</span>.<span class="bu">format</span>(code), titlefont<span class="op">=</span><span class="bu">dict</span>(size<span class="op">=</span><span class="dv">20</span>, color<span class="op">=</span><span class="st">'black'</span>))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> go.Figure(data<span class="op">=</span>[candle, line_ma5, line_ma20, line_ma60, line_ma120], layout<span class="op">=</span>layout)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fc48d7c375d44d4b9b04614c0ff9e01e","version_major":2,"version_minor":0}
</script>
</div>
</div>
<p>위의 캔들차트에서 원하는 코드를 선택하여 4일, 20일, 60일, 120일 이동평균선을 확인할 수 있다.</p>
<p><br> <br></p>
</section>
<section id="보조지표-추가" class="level2">
<h2 class="anchored" data-anchor-id="보조지표-추가">(2) 보조지표 추가</h2>
<p>현재 baseline 모델에서는 10일치의 시가, 고가, 저가, 종가, 거래대금을 독립변수로 하여 학습을 진행하였다.</p>
<p><img src="03.add_index_files/figure-html/b707086b-1-c8e49983-af70-445a-8751-d85d55a7171a.png" class="img-fluid" alt="image.png">출처-네이버 증권</p>
<p>하지만 10일간의 주가 차트 예시 사진을 보면, 너무 적은 정보만을 담고 있어 주가 예측을 위한 패턴을 찾아내기란 매우 어렵다. 따라서 주식의 여러 보조지표를 사용해서 해당 주식에 대한 압축된 정보를 독립변수에 추가해준다.</p>
<p>앞서 시각화 해보았던 이동평균선 말고도 다양한 주식 보조지표들이 존재한다. 보조지표들을 모두 수동으로 계산하기에는 어려움이 있으므로 TA 라이브러리를 사용하여 총 49개의 보조지표를 추가한다. (+ trading_value)</p>
<p>-<a href="https://github.com/mrjbq7/ta-lib">TA library github</a></p>
<ul>
<li>보조지표 추가 코드</li>
</ul>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_index <span class="op">=</span> pd.DataFrame()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> code, stock_df <span class="kw">in</span> tqdm(df_stock.groupby(<span class="st">'Code'</span>)):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 이평선 생성</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    ma <span class="op">=</span> [<span class="dv">5</span>,<span class="dv">20</span>,<span class="dv">60</span>,<span class="dv">120</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> days <span class="kw">in</span> ma:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        stock_df[<span class="st">'ma_'</span><span class="op">+</span><span class="bu">str</span>(days)] <span class="op">=</span> stock_df[<span class="st">'Close'</span>].rolling(window <span class="op">=</span> days).mean()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 여러 보조 지표 생성</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    H, L, C, V <span class="op">=</span> stock_df[<span class="st">'High'</span>], stock_df[<span class="st">'Low'</span>], stock_df[<span class="st">'Close'</span>], stock_df[<span class="st">'Volume'</span>]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'trading_value'</span>] <span class="op">=</span> stock_df[<span class="st">'Close'</span>]<span class="op">*</span>stock_df[<span class="st">'Volume'</span>]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'MFI'</span>] <span class="op">=</span> ta.volume.money_flow_index(</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'ADI'</span>] <span class="op">=</span> ta.volume.acc_dist_index(</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'OBV'</span>] <span class="op">=</span> ta.volume.on_balance_volume(close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'CMF'</span>] <span class="op">=</span> ta.volume.chaikin_money_flow(</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'FI'</span>] <span class="op">=</span> ta.volume.force_index(close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'EOMEMV'</span>] <span class="op">=</span> ta.volume.ease_of_movement(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'VPT'</span>] <span class="op">=</span> ta.volume.volume_price_trend(close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'NVI'</span>] <span class="op">=</span> ta.volume.negative_volume_index(close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'VMAP'</span>] <span class="op">=</span> ta.volume.volume_weighted_average_price(</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Volatility</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'ATR'</span>] <span class="op">=</span> ta.volatility.average_true_range(</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'BHB'</span>] <span class="op">=</span> ta.volatility.bollinger_hband(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'BLB'</span>] <span class="op">=</span> ta.volatility.bollinger_lband(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'KCH'</span>] <span class="op">=</span> ta.volatility.keltner_channel_hband(</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'KCL'</span>] <span class="op">=</span> ta.volatility.keltner_channel_lband(</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'KCM'</span>] <span class="op">=</span> ta.volatility.keltner_channel_mband(</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'DCH'</span>] <span class="op">=</span> ta.volatility.donchian_channel_hband(</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'DCL'</span>] <span class="op">=</span> ta.volatility.donchian_channel_lband(</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'DCM'</span>] <span class="op">=</span> ta.volatility.donchian_channel_mband(</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'UI'</span>] <span class="op">=</span> ta.volatility.ulcer_index(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trend</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'SMA'</span>] <span class="op">=</span> ta.trend.sma_indicator(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'EMA'</span>] <span class="op">=</span> ta.trend.ema_indicator(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'WMA'</span>] <span class="op">=</span> ta.trend.wma_indicator(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'MACD'</span>] <span class="op">=</span> ta.trend.macd(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'ADX'</span>] <span class="op">=</span> ta.trend.adx(high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'VIneg'</span>] <span class="op">=</span> ta.trend.vortex_indicator_neg(</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'VIpos'</span>] <span class="op">=</span> ta.trend.vortex_indicator_pos(</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'TRIX'</span>] <span class="op">=</span> ta.trend.trix(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'MI'</span>] <span class="op">=</span> ta.trend.mass_index(high<span class="op">=</span>H, low<span class="op">=</span>L, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'CCI'</span>] <span class="op">=</span> ta.trend.cci(high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'DPO'</span>] <span class="op">=</span> ta.trend.dpo(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'KST'</span>] <span class="op">=</span> ta.trend.kst(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'Ichimoku'</span>] <span class="op">=</span> ta.trend.ichimoku_a(high<span class="op">=</span>H, low<span class="op">=</span>L, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'ParabolicSAR'</span>] <span class="op">=</span> ta.trend.psar_down(</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'STC'</span>] <span class="op">=</span> ta.trend.stc(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Momentum</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'RSI'</span>] <span class="op">=</span> ta.momentum.rsi(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'SRSI'</span>] <span class="op">=</span> ta.momentum.stochrsi(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'TSI'</span>] <span class="op">=</span> ta.momentum.tsi(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'UO'</span>] <span class="op">=</span> ta.momentum.ultimate_oscillator(</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>        high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'SR'</span>] <span class="op">=</span> ta.momentum.stoch(close<span class="op">=</span>C, high<span class="op">=</span>H, low<span class="op">=</span>L, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'WR'</span>] <span class="op">=</span> ta.momentum.williams_r(high<span class="op">=</span>H, low<span class="op">=</span>L, close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'AO'</span>] <span class="op">=</span> ta.momentum.awesome_oscillator(high<span class="op">=</span>H, low<span class="op">=</span>L, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'KAMA'</span>] <span class="op">=</span> ta.momentum.kama(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'ROC'</span>] <span class="op">=</span> ta.momentum.roc(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'PPO'</span>] <span class="op">=</span> ta.momentum.ppo(close<span class="op">=</span>C, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'PVO'</span>] <span class="op">=</span> ta.momentum.pvo(volume<span class="op">=</span>V, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    df_index <span class="op">=</span> df_index.append(stock_df) </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a><span class="co"># 저장</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>df_index.to_csv(<span class="st">"stock_data_2018_2020_add_index.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>df_index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████| 1561/1561 [07:35&lt;00:00,  3.42it/s]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Code</th>
      <th>Date</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Change</th>
      <th>ma_5</th>
      <th>ma_20</th>
      <th>...</th>
      <th>SRSI</th>
      <th>TSI</th>
      <th>UO</th>
      <th>SR</th>
      <th>WR</th>
      <th>AO</th>
      <th>KAMA</th>
      <th>ROC</th>
      <th>PPO</th>
      <th>PVO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>862985</th>
      <td>000020</td>
      <td>2018-01-02</td>
      <td>9750</td>
      <td>9900</td>
      <td>9700</td>
      <td>9870</td>
      <td>120676</td>
      <td>0.012308</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>85.000000</td>
      <td>-15.000000</td>
      <td>0.000000</td>
      <td>9870.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>862986</th>
      <td>000020</td>
      <td>2018-01-03</td>
      <td>9900</td>
      <td>10250</td>
      <td>9820</td>
      <td>10000</td>
      <td>268220</td>
      <td>0.013171</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000000</td>
      <td>100.000000</td>
      <td>28.571429</td>
      <td>54.545455</td>
      <td>-45.454545</td>
      <td>0.000000</td>
      <td>9925.471999</td>
      <td>0.000000</td>
      <td>0.104967</td>
      <td>8.943334</td>
    </tr>
    <tr>
      <th>862987</th>
      <td>000020</td>
      <td>2018-01-04</td>
      <td>10050</td>
      <td>10050</td>
      <td>9680</td>
      <td>9750</td>
      <td>161342</td>
      <td>-0.025000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000000</td>
      <td>95.815900</td>
      <td>25.000000</td>
      <td>12.280702</td>
      <td>-87.719298</td>
      <td>0.000000</td>
      <td>9854.744908</td>
      <td>0.000000</td>
      <td>-0.015865</td>
      <td>9.215678</td>
    </tr>
    <tr>
      <th>862988</th>
      <td>000020</td>
      <td>2018-01-05</td>
      <td>9750</td>
      <td>9980</td>
      <td>9750</td>
      <td>9910</td>
      <td>116604</td>
      <td>0.016410</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000000</td>
      <td>92.627651</td>
      <td>33.333333</td>
      <td>40.350877</td>
      <td>-59.649123</td>
      <td>0.000000</td>
      <td>9882.663078</td>
      <td>0.000000</td>
      <td>0.018877</td>
      <td>6.837356</td>
    </tr>
    <tr>
      <th>862989</th>
      <td>000020</td>
      <td>2018-01-08</td>
      <td>10000</td>
      <td>10150</td>
      <td>9940</td>
      <td>9950</td>
      <td>158326</td>
      <td>0.004036</td>
      <td>9896.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000000</td>
      <td>90.156386</td>
      <td>30.612245</td>
      <td>47.368421</td>
      <td>-52.631579</td>
      <td>0.000000</td>
      <td>9935.876263</td>
      <td>0.000000</td>
      <td>0.078152</td>
      <td>7.233628</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>43418</th>
      <td>950130</td>
      <td>2020-12-22</td>
      <td>23950</td>
      <td>23950</td>
      <td>22800</td>
      <td>22900</td>
      <td>978011</td>
      <td>-0.043841</td>
      <td>23490.0</td>
      <td>22212.5</td>
      <td>...</td>
      <td>0.601825</td>
      <td>-1.890990</td>
      <td>29.641945</td>
      <td>41.379310</td>
      <td>-58.620690</td>
      <td>577.058824</td>
      <td>22725.390944</td>
      <td>17.737789</td>
      <td>-0.505568</td>
      <td>-12.450728</td>
    </tr>
    <tr>
      <th>43419</th>
      <td>950130</td>
      <td>2020-12-23</td>
      <td>23000</td>
      <td>23300</td>
      <td>21000</td>
      <td>21450</td>
      <td>1239228</td>
      <td>-0.063319</td>
      <td>23080.0</td>
      <td>22310.0</td>
      <td>...</td>
      <td>0.353271</td>
      <td>-3.660151</td>
      <td>28.338277</td>
      <td>23.963134</td>
      <td>-76.036866</td>
      <td>353.382353</td>
      <td>22679.784965</td>
      <td>-15.049505</td>
      <td>-1.064724</td>
      <td>-16.358507</td>
    </tr>
    <tr>
      <th>43420</th>
      <td>950130</td>
      <td>2020-12-24</td>
      <td>21500</td>
      <td>21800</td>
      <td>19600</td>
      <td>21700</td>
      <td>857865</td>
      <td>0.011655</td>
      <td>22700.0</td>
      <td>22382.5</td>
      <td>...</td>
      <td>0.083197</td>
      <td>-4.812902</td>
      <td>38.852203</td>
      <td>20.792079</td>
      <td>-79.207921</td>
      <td>-58.235294</td>
      <td>22583.248771</td>
      <td>-12.323232</td>
      <td>-1.408773</td>
      <td>-20.829146</td>
    </tr>
    <tr>
      <th>43421</th>
      <td>950130</td>
      <td>2020-12-28</td>
      <td>21750</td>
      <td>21800</td>
      <td>19500</td>
      <td>19650</td>
      <td>1523257</td>
      <td>-0.094470</td>
      <td>21930.0</td>
      <td>22322.5</td>
      <td>...</td>
      <td>0.000000</td>
      <td>-7.972071</td>
      <td>33.462925</td>
      <td>1.470588</td>
      <td>-98.529412</td>
      <td>-402.647059</td>
      <td>22055.737842</td>
      <td>-13.245033</td>
      <td>-2.394064</td>
      <td>-22.448964</td>
    </tr>
    <tr>
      <th>43422</th>
      <td>950130</td>
      <td>2020-12-29</td>
      <td>19950</td>
      <td>22450</td>
      <td>19900</td>
      <td>21500</td>
      <td>1568505</td>
      <td>0.094148</td>
      <td>21440.0</td>
      <td>22392.5</td>
      <td>...</td>
      <td>0.526558</td>
      <td>-8.199398</td>
      <td>40.132825</td>
      <td>28.169014</td>
      <td>-71.830986</td>
      <td>-759.852941</td>
      <td>22026.178902</td>
      <td>-9.473684</td>
      <td>-2.489633</td>
      <td>-23.522675</td>
    </tr>
  </tbody>
</table>
<p>1149377 rows × 58 columns</p>
</div>
</div>
</div>
<p>보조지표를 추가하여 8개였던 컬럼이 58개의 컬럼이 된 것을 확인하였다.</p>
<p><br> <br></p>
</section>
<section id="모델-학습" class="level2">
<h2 class="anchored" data-anchor-id="모델-학습">(3) 모델 학습</h2>
<ul>
<li><strong>데이터셋 생성 함수</strong></li>
</ul>
<p>위에서 보조지표를 추가 했던 방법과 동일하게 미리 생성해 놓은 보조지표 추가 데이터셋을 서버 DB에서 불러온다. baseline 모델에서 진행했던 데이터셋을 더 늘려 train 2017-2020, test 2021 기간 동안의 데이터를 사용한다.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_dataset(train<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    IF <span class="op">=</span> <span class="bu">open</span>(<span class="st">'../data/code_list.txt'</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    lst_code <span class="op">=</span> IF.readlines()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    lst_X <span class="op">=</span> []</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    lst_Y <span class="op">=</span> []</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    lst_code_date <span class="op">=</span> []</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    db_dsml <span class="op">=</span> pymysql.<span class="ex">connect</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        host <span class="op">=</span> <span class="st">'localhost'</span>, </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        port <span class="op">=</span> <span class="dv">3306</span>, </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> <span class="st">'[db username]'</span>, </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        passwd <span class="op">=</span> <span class="st">'[db password]'</span>, </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        db <span class="op">=</span> <span class="st">'[db name]'</span>, </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        charset <span class="op">=</span> <span class="st">'utf8'</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    cursor <span class="op">=</span> db_dsml.cursor()</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> code <span class="kw">in</span> tqdm(lst_code): </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        code <span class="op">=</span> code.strip()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> train: </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            sql_query <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="st">                        SELECT *</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="st">                        FROM stock_</span><span class="sc">{}</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="st">                        WHERE Date BETWEEN '2017-01-01' AND '2020-12-31'</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="st">                        '''</span>.<span class="bu">format</span>(code)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            sql_query <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="st">                        SELECT *</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="st">                        FROM stock_</span><span class="sc">{}</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="st">                        WHERE Date BETWEEN '2021-01-01' AND '2021-12-31'</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="st">                        '''</span>.<span class="bu">format</span>(code)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        stock <span class="op">=</span> pd.read_sql(sql <span class="op">=</span> sql_query, con <span class="op">=</span> db_dsml)   </span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        lst_stock <span class="op">=</span> stock.values.tolist()</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> <span class="bu">enumerate</span>(lst_stock): </span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            date, trading_value <span class="op">=</span> row[<span class="dv">0</span>].date().strftime(<span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">"</span>), row[<span class="dv">4</span>]<span class="op">*</span>row[<span class="dv">5</span>]</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> trading_value <span class="op">&gt;=</span> <span class="dv">100000000000</span>:</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (idx <span class="op">&lt;</span> <span class="dv">9</span>) <span class="kw">or</span> (idx <span class="op">&gt;=</span> <span class="bu">len</span>(lst_stock)<span class="op">-</span><span class="dv">1</span>): <span class="co"># 예외 처리 </span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span> </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                <span class="co"># D-9 ~ D0 데이터만 담기 </span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                sub_stock <span class="op">=</span> lst_stock[idx<span class="op">-</span><span class="dv">9</span>:idx<span class="op">+</span><span class="dv">1</span>] </span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 10일간의 데이터 </span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                lst_result <span class="op">=</span> []</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> row2 <span class="kw">in</span> sub_stock:</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>                    lst_prices, lst_index <span class="op">=</span> row2[<span class="dv">1</span>:<span class="dv">6</span>], row2[<span class="dv">8</span>:]</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                    lst_result <span class="op">+=</span> lst_prices <span class="op">+</span> lst_index <span class="op">+</span> [trading_value]</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>                <span class="co"># D+1 종가 2% 상승 여부 </span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> <span class="bu">int</span>(row[<span class="dv">7</span>] <span class="op">&gt;=</span> <span class="fl">0.02</span>)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 종속변수, 독립변수, 종목코드, 날짜 리스트에 추가 </span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                lst_X.append(lst_result)</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                lst_Y.append(label)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                lst_code_date.append([code, date])</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(lst_X), np.array(lst_Y), np.array(lst_code_date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>train dataset 생성</strong></li>
</ul>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>trainX, trainY, lst_code_date <span class="op">=</span> make_dataset(train<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████| 1561/1561 [02:16&lt;00:00, 11.44it/s]</code></pre>
</div>
</div>
<ul>
<li><strong>test dataset 생성</strong></li>
</ul>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>testX, testY, lst_code_date_test <span class="op">=</span> make_dataset(train<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████| 1561/1561 [00:40&lt;00:00, 38.37it/s]</code></pre>
</div>
</div>
<ul>
<li>pickle 저장</li>
</ul>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-hide</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>dic_result <span class="op">=</span> {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'train'</span>: [trainX, trainY, lst_code_date],</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'test'</span>: [testX, testY, lst_code_date_test]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'dataset_2020_2021.pickle'</span>, <span class="st">'wb'</span>) <span class="im">as</span> handle:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    pickle.dump(dic_result, handle, protocol<span class="op">=</span>pickle.HIGHEST_PROTOCOL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>pickle 불러오기</li>
</ul>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-hide</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'dataset_2020_2021.pickle'</span>, <span class="st">'rb'</span>) <span class="im">as</span> handle:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> pickle.load(handle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>trainX, trainY, lst_code_date <span class="op">=</span> dataset[<span class="st">'train'</span>][<span class="dv">0</span>], dataset[<span class="st">'train'</span>][<span class="dv">1</span>], dataset[<span class="st">'train'</span>][<span class="dv">2</span>]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>testX, testY, lst_code_date_test <span class="op">=</span> dataset[<span class="st">'test'</span>][<span class="dv">0</span>], dataset[<span class="st">'test'</span>][<span class="dv">1</span>], dataset[<span class="st">'test'</span>][<span class="dv">2</span>]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'train dataset: '</span>, trainX.shape, trainY.shape)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'test dataset: '</span>, testX.shape, testY.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>train dataset:  (13870, 550) (13870,)
test dataset:  (8341, 550) (8341,)</code></pre>
</div>
</div>
<ul>
<li><strong>XGBoost 모델 학습</strong></li>
</ul>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>xgb <span class="op">=</span> XGBClassifier(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                   n_jobs<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                   scale_pos_weight<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                   learning_rate<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                   max_depth<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                   n_estimators<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                   ) </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>xgb.fit(trainX, trainY)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[17:26:28] WARNING: ../src/learner.cc:1115: Starting in XGBoost 1.3.0, the default evaluation metric used with the objective 'binary:logistic' was changed from 'error' to 'logloss'. Explicitly set eval_metric if you'd like to restore the old behavior.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>XGBClassifier(base_score=0.5, booster='gbtree', colsample_bylevel=1,
              colsample_bynode=1, colsample_bytree=1, enable_categorical=False,
              gamma=0, gpu_id=-1, importance_type=None,
              interaction_constraints='', learning_rate=0.01, max_delta_step=0,
              max_depth=3, min_child_weight=1, missing=nan,
              monotone_constraints='()', n_estimators=500, n_jobs=40,
              num_parallel_tree=1, predictor='auto', random_state=0,
              reg_alpha=0, reg_lambda=1, scale_pos_weight=4, subsample=1,
              tree_method='exact', validate_parameters=1, verbosity=None)</code></pre>
</div>
</div>
<ul>
<li><strong>모델 평가지표 시각화 함수</strong><br>
train, test 데이터셋에 대하여 Accuracy, AUC, f1_score, precision, recall 평가지표를 구하고, 시각화 한다.</li>
</ul>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_evauate(trainX, trainY, testX, testY, model):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve, roc_auc_score, f1_score, f1_score, accuracy_score, recall_score, precision_score</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    train_pred <span class="op">=</span> model.predict(trainX)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    train_prob <span class="op">=</span> model.predict_proba(trainX)[:, <span class="dv">1</span>]</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    test_pred <span class="op">=</span> model.predict(testX) </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    test_prob <span class="op">=</span> model.predict_proba(testX)[:, <span class="dv">1</span>]</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ROC Curve 시각화 </span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, thresholds <span class="op">=</span> roc_curve(testY, test_prob) </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    plt.plot(fpr, tpr, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'ROC'</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'False Positive Rate'</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'True Positive Rate'</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'test ROC : </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">round</span>(roc_auc_score(testY, test_prob),<span class="dv">3</span>)),fontsize<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 여러 평가지표 시각화 </span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    dic_name2func <span class="op">=</span> { <span class="st">'F1-score'</span>: f1_score, </span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'Recall'</span>: recall_score, </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'Precision'</span>: precision_score, </span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'Accuracy'</span>: accuracy_score, </span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'ROCAUC'</span>: roc_auc_score }</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    lst_result <span class="op">=</span> []</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, func <span class="kw">in</span> dic_name2func.items():</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="op">==</span> <span class="st">'ROCAUC'</span>:</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>            train <span class="op">=</span> func(trainY, train_prob)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>            test <span class="op">=</span> func(testY, test_prob)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>            train <span class="op">=</span> func(trainY, train_pred)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>            test <span class="op">=</span> func(testY, test_pred)</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        lst_result.append([name, train, test])</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(data<span class="op">=</span>lst_result,</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">=</span>[<span class="st">'name'</span>, <span class="st">'train'</span>, <span class="st">'test'</span>])</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.melt(id_vars<span class="op">=</span><span class="st">'name'</span>)    </span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> sns.barplot(data<span class="op">=</span>df, x<span class="op">=</span><span class="st">'name'</span>, y<span class="op">=</span><span class="st">'value'</span>, hue<span class="op">=</span><span class="st">'variable'</span>)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 텍스트 추가 </span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> p.get_height()</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>        ax.text(p.get_x() <span class="op">+</span> p.get_width() <span class="op">/</span> <span class="fl">2.</span>, height <span class="op">+</span> <span class="fl">0.01</span>, <span class="bu">round</span>(height, <span class="dv">3</span>), ha <span class="op">=</span> <span class="st">'center'</span>, size <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>성능 평가</strong></li>
</ul>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plot_evauate(trainX, trainY, testX, testY, xgb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03.add_index_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="03.add_index_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>rocauc score는 0.595의 성능을 보였다. 데이터의 기간을 늘리고, 보조지표를 추가함으로써 지난 글의 Baseline Model의 0.56 보다 성능이 향상되었다.<br>
다음 글에서는 현재 사용하고 있는 통합 종목 주가 데이터셋의 종목별 가격이 모두 다른 점을 보완하기 위해 데이터를 표준화하는 시간을 가진다.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>