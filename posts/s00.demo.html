<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="agsu">
<meta name="dcterms.date" content="2023-02-02">

<title>Data Analysis blog - stockait stockait 사용하여 주가 예측 모델 학습하기</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Data Analysis blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ag-su"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://agsu.tistory.com/"><i class="bi bi-box2-heart" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">[stockait] stockait 사용하여 주가 예측 모델 학습하기</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">project</div>
                <div class="quarto-category">stockait</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>agsu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 2, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="stockait" class="level2">
<h2 class="anchored" data-anchor-id="stockait">stockait</h2>
<p>본 글에서는 직접 개발한 파이썬 라이브러리 stockait 사용법을 정리합니다. stockait는 주가 빅데이터 연구를 위한 통합 라이브러리로, 데이터 수집부터 데이터 전처리, 모델 학습 모델 평가, 수익률 계산까지 모든 과정을 이 라이브러리에서 사용할 수 있습니다.</p>
<p>라이브러리의 전체적인 흐름 및 사용법을 다음의 과정으로 정리하도록 하겠습니다.<br>
<code>데이터 수집</code> - <code>데이터 전처리</code> - <code>트레이더 정의</code> - <code>트레이더 사용(모델 학습 &amp; 평가)</code> - <code>수익률 시뮬레이션</code></p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> stockait <span class="im">as</span> sai</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br> <br></p>
</section>
<section id="데이터-수집" class="level1">
<h1>1. 데이터 수집</h1>
<blockquote class="blockquote">
<p>0) 나라 리스트 가져오기: <code>sai.get_countries()</code><br>
1) 나라 별 시장 가져오기: <code>sai.get_markets(country:list)</code><br>
2) 시장 별 종목코드 가져오기: <code>sai.get_tickers(date:list, tickers:list=None)</code><br>
3) 원하는 종목의 주가 데이터 수집: <code>sai.load_data(date:list, tickers:list=None)</code></p>
</blockquote>
<p><br></p>
<p>stockait는 총 41개의 나라와 69개의 주식 시장을 갖고 있습니다. 함수를 사용해서 이용 가능한 나라와 시장, 그리고 종목코드를 확인할 수 있습니다.</p>
<p><br></p>
<section id="나라-별-시장-가져오기" class="level3">
<h3 class="anchored" data-anchor-id="나라-별-시장-가져오기">1) 나라 별 시장 가져오기</h3>
<p>먼저, 특정 국가에 해당하는 시장을 불러오겠습니다. stockait에서 사용할 수 있는 국가들의 리스트도 get_countries 함수를 사용하여 불러올 수 있습니다.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>check_countries <span class="op">=</span> sai.get_countries()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(check_countries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Argentina', 'Australia', 'Austria', 'Belgium', 'Brazil', 'Canada', 'China', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hong Kong', 'Iceland', 'India', 'Indonesia', 'Ireland', 'Israel', 'Italy', 'Latvia', 'Lithuania', 'Malaysia', 'Mexico', 'Netherlands', 'New Zealand', 'Norway', 'Portugal', 'Qatar', 'Russia', 'Singapore', 'South Korea', 'Spain', 'Sweden', 'Switzerland', 'Taiwan', 'Thailand', 'Turkey', 'USA', 'United Kingdom', 'Venezuela']</code></pre>
</div>
</div>
<p>이용 가능한 나라 중에서 원하는 곳을 문자열로 넣으면,</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lst_markets <span class="op">=</span> sai.get_markets(country<span class="op">=</span><span class="st">'South Korea'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(lst_markets), lst_markets[:<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3 ['KOSPI', 'KOSDAQ', 'KONEX']</code></pre>
</div>
</div>
<p>위와 같이 South Korea의 이용가능한 주식 시장을 불러오게 됩니다.</p>
<p><br></p>
</section>
<section id="시장-별-종목코드-가져오기" class="level3">
<h3 class="anchored" data-anchor-id="시장-별-종목코드-가져오기">2) 시장 별 종목코드 가져오기</h3>
<p>위에서 확인한 시장을 리스트에 모두 넣어도 되고, 원하는 개별 시장을 넣어주어도 됩니다.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lst_tickers <span class="op">=</span> sai.get_tickers(markets<span class="op">=</span>[<span class="st">'KOSPI'</span>])</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(lst_tickers), lst_tickers[:<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>920 ['095570', '006840', '282330', '027410', '138930']</code></pre>
</div>
</div>
<p>예시로, KOSPI 시장만 리스트에 넣어 get_tickers 함수를 사용하여 920개의 종목코드를 얻었습니다.</p>
<p><br></p>
</section>
<section id="원하는-종목의-주가-데이터-수집" class="level3">
<h3 class="anchored" data-anchor-id="원하는-종목의-주가-데이터-수집">3) 원하는 종목의 주가 데이터 수집</h3>
<p>연구하고자 하는 주가 데이터의 날짜와 종목코드 리스트를 넣어주면, 그에 해당하는 데이터를 불러올 수 있습니다.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>raw_data <span class="op">=</span> sai.load_data(date<span class="op">=</span>[<span class="st">'2016-01-01'</span>, <span class="st">'2021-12-31'</span>], tickers<span class="op">=</span>lst_tickers[:<span class="dv">500</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raw_data.shape)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>raw_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████████████████████████████████████████████████████| 500/500 [00:31&lt;00:00, 15.76it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(690152, 7)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Code</th>
      <th>Date</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>2016-01-04</td>
      <td>8130</td>
      <td>8150</td>
      <td>7920</td>
      <td>8140</td>
      <td>281440</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000020</td>
      <td>2016-01-05</td>
      <td>8040</td>
      <td>8250</td>
      <td>8000</td>
      <td>8190</td>
      <td>243179</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000020</td>
      <td>2016-01-06</td>
      <td>8200</td>
      <td>8590</td>
      <td>8110</td>
      <td>8550</td>
      <td>609906</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000020</td>
      <td>2016-01-07</td>
      <td>8470</td>
      <td>8690</td>
      <td>8190</td>
      <td>8380</td>
      <td>704752</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000020</td>
      <td>2016-01-08</td>
      <td>8210</td>
      <td>8900</td>
      <td>8130</td>
      <td>8770</td>
      <td>802330</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>위에서 얻은 920개의 종목코드를 넣어주어, 총 1266395행의 데이터를 정상적으로 불러왔습니다.</p>
<p><br> <br></p>
</section>
</section>
<section id="데이터-전처리" class="level1">
<h1>2. 데이터 전처리</h1>
<blockquote class="blockquote">
<p>1) 보조지표 추가 : <code>sai.add_index(data:pd.DataFrame(), index_list:list)</code><br>
2) 스케일링: <code>sai.scaling(data:pd.DataFrame(), scaler_type:String, window_size:Int=None)</code><br>
3) 시계열 데이터 변환: <code>sai.time_series(data:pd.DataFrame(), day:Int=10)</code></p>
</blockquote>
<p><br></p>
<section id="보조지표-추가" class="level3">
<h3 class="anchored" data-anchor-id="보조지표-추가">1) 보조지표 추가</h3>
<ul>
<li><p><strong>next_change는 익일 종가 변동율로, stockait에서 제공하는 기본 종속변수입니다.</strong><br>
‘next_change’</p></li>
<li><p><strong>stockait에서 제공하는, TA Package를 사용하여 계산되는 보조지표들입니다.</strong><br>
‘MA5’, ‘MA20’, ‘MA60’,‘MA120’, ‘next_change’, ‘ADI’,‘CMF’,‘VPT’,‘VMAP’, ‘BHB’,‘BLB’,‘KCH’,‘KCL’,‘KCM’,‘DCH’,‘DCL’,‘DCM’,‘UI’, ‘SMA’,‘EMA’,‘WMA’,‘MACD’,‘VIneg’,‘VIpos’,‘TRIX’,‘MI’,‘CCI’,‘DPO’,‘KST’,‘Ichimoku’,‘ParabolicSAR’,‘STC’, ‘RSI’,‘SRSI’,‘TSI’,‘UO’,‘SR’,‘WR’,‘AO’,‘ROC’,‘PPO’,‘PVO’</p></li>
</ul>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>check_index <span class="op">=</span> [<span class="st">'MA5'</span>, <span class="st">'MA20'</span>, <span class="st">'MA60'</span>,<span class="st">'MA120'</span>, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">'next_change'</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">'ADI'</span>,<span class="st">'CMF'</span>,<span class="st">'VPT'</span>,<span class="st">'VMAP'</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'BHB'</span>,<span class="st">'BLB'</span>,<span class="st">'KCH'</span>,<span class="st">'KCL'</span>,<span class="st">'KCM'</span>,<span class="st">'DCH'</span>,<span class="st">'DCL'</span>,<span class="st">'DCM'</span>,<span class="st">'UI'</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SMA'</span>,<span class="st">'EMA'</span>,<span class="st">'WMA'</span>,<span class="st">'MACD'</span>,<span class="st">'VIneg'</span>,<span class="st">'VIpos'</span>,<span class="st">'TRIX'</span>,<span class="st">'MI'</span>,<span class="st">'CCI'</span>,<span class="st">'DPO'</span>,<span class="st">'KST'</span>,<span class="st">'Ichimoku'</span>,<span class="st">'ParabolicSAR'</span>,<span class="st">'STC'</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">'RSI'</span>,<span class="st">'SRSI'</span>,<span class="st">'TSI'</span>,<span class="st">'UO'</span>,<span class="st">'SR'</span>,<span class="st">'WR'</span>,<span class="st">'AO'</span>,<span class="st">'ROC'</span>,<span class="st">'PPO'</span>,<span class="st">'PVO'</span>]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>check_df <span class="op">=</span> sai.add_index(data<span class="op">=</span>raw_data, index_list<span class="op">=</span>check_index)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>check_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████████████████████████████████████████████████████| 495/495 [07:13&lt;00:00,  1.14it/s]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Code</th>
      <th>Date</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Change</th>
      <th>MA5</th>
      <th>MA20</th>
      <th>...</th>
      <th>RSI</th>
      <th>SRSI</th>
      <th>TSI</th>
      <th>UO</th>
      <th>SR</th>
      <th>WR</th>
      <th>AO</th>
      <th>ROC</th>
      <th>PPO</th>
      <th>PVO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>2016-06-29</td>
      <td>9850</td>
      <td>10100</td>
      <td>9700</td>
      <td>9750</td>
      <td>352292</td>
      <td>-0.001025</td>
      <td>9544.0</td>
      <td>10210.0</td>
      <td>...</td>
      <td>45.763505</td>
      <td>0.529126</td>
      <td>-8.116135</td>
      <td>0.0</td>
      <td>41.176471</td>
      <td>-58.823529</td>
      <td>-827.794118</td>
      <td>-3.940887</td>
      <td>-1.408719</td>
      <td>-11.019576</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000020</td>
      <td>2016-06-30</td>
      <td>9850</td>
      <td>10400</td>
      <td>9760</td>
      <td>10100</td>
      <td>466248</td>
      <td>0.035897</td>
      <td>9618.0</td>
      <td>10195.0</td>
      <td>...</td>
      <td>51.232344</td>
      <td>0.875363</td>
      <td>-6.553028</td>
      <td>0.0</td>
      <td>54.901961</td>
      <td>-45.098039</td>
      <td>-765.088235</td>
      <td>-2.415459</td>
      <td>-1.124410</td>
      <td>-9.119594</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000020</td>
      <td>2016-07-01</td>
      <td>10200</td>
      <td>10200</td>
      <td>9960</td>
      <td>9960</td>
      <td>208228</td>
      <td>-0.013861</td>
      <td>9794.0</td>
      <td>10148.0</td>
      <td>...</td>
      <td>49.099659</td>
      <td>0.767924</td>
      <td>-5.911240</td>
      <td>0.0</td>
      <td>49.411765</td>
      <td>-50.588235</td>
      <td>-624.205882</td>
      <td>-4.230769</td>
      <td>-1.001426</td>
      <td>-12.558989</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000020</td>
      <td>2016-07-04</td>
      <td>10000</td>
      <td>10400</td>
      <td>9900</td>
      <td>10400</td>
      <td>275210</td>
      <td>0.044177</td>
      <td>9994.0</td>
      <td>10135.5</td>
      <td>...</td>
      <td>55.385557</td>
      <td>1.000000</td>
      <td>-3.312304</td>
      <td>0.0</td>
      <td>66.666667</td>
      <td>-33.333333</td>
      <td>-427.205882</td>
      <td>-0.952381</td>
      <td>-0.541344</td>
      <td>-13.975141</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000020</td>
      <td>2016-07-05</td>
      <td>10400</td>
      <td>10450</td>
      <td>10200</td>
      <td>10350</td>
      <td>156010</td>
      <td>-0.004808</td>
      <td>10112.0</td>
      <td>10118.0</td>
      <td>...</td>
      <td>54.560981</td>
      <td>0.961700</td>
      <td>-1.483696</td>
      <td>0.0</td>
      <td>64.705882</td>
      <td>-35.294118</td>
      <td>-266.529412</td>
      <td>1.970443</td>
      <td>-0.216142</td>
      <td>-17.711174</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>631159</th>
      <td>383220</td>
      <td>2021-12-23</td>
      <td>177600</td>
      <td>179400</td>
      <td>175800</td>
      <td>176000</td>
      <td>49393</td>
      <td>-0.00565</td>
      <td>178240.0</td>
      <td>173970.0</td>
      <td>...</td>
      <td>50.940761</td>
      <td>0.253349</td>
      <td>4.242959</td>
      <td>0.0</td>
      <td>47.169811</td>
      <td>-52.830189</td>
      <td>739.411765</td>
      <td>1.033295</td>
      <td>0.479735</td>
      <td>-7.390941</td>
    </tr>
    <tr>
      <th>631160</th>
      <td>383220</td>
      <td>2021-12-24</td>
      <td>177200</td>
      <td>177200</td>
      <td>164400</td>
      <td>176000</td>
      <td>53197</td>
      <td>0.0</td>
      <td>177160.0</td>
      <td>174320.0</td>
      <td>...</td>
      <td>50.940761</td>
      <td>0.253349</td>
      <td>3.921902</td>
      <td>0.0</td>
      <td>67.441860</td>
      <td>-32.558140</td>
      <td>-27.058824</td>
      <td>0.686499</td>
      <td>0.428087</td>
      <td>-4.519611</td>
    </tr>
    <tr>
      <th>631161</th>
      <td>383220</td>
      <td>2021-12-27</td>
      <td>178000</td>
      <td>181000</td>
      <td>175600</td>
      <td>179000</td>
      <td>42262</td>
      <td>0.017045</td>
      <td>177000.0</td>
      <td>174870.0</td>
      <td>...</td>
      <td>55.627962</td>
      <td>0.666579</td>
      <td>4.893728</td>
      <td>0.0</td>
      <td>84.883721</td>
      <td>-15.116279</td>
      <td>347.647059</td>
      <td>1.820250</td>
      <td>0.518392</td>
      <td>-4.275590</td>
    </tr>
    <tr>
      <th>631162</th>
      <td>383220</td>
      <td>2021-12-28</td>
      <td>180200</td>
      <td>189800</td>
      <td>178400</td>
      <td>189400</td>
      <td>78018</td>
      <td>0.058101</td>
      <td>179480.0</td>
      <td>176040.0</td>
      <td>...</td>
      <td>67.293872</td>
      <td>1.000000</td>
      <td>9.859346</td>
      <td>0.0</td>
      <td>98.425197</td>
      <td>-1.574803</td>
      <td>1632.941176</td>
      <td>8.975834</td>
      <td>1.049621</td>
      <td>2.260368</td>
    </tr>
    <tr>
      <th>631163</th>
      <td>383220</td>
      <td>2021-12-29</td>
      <td>191400</td>
      <td>199600</td>
      <td>191400</td>
      <td>195800</td>
      <td>74152</td>
      <td>0.033791</td>
      <td>183240.0</td>
      <td>177580.0</td>
      <td>...</td>
      <td>72.146913</td>
      <td>1.000000</td>
      <td>16.001174</td>
      <td>0.0</td>
      <td>89.204545</td>
      <td>-10.795455</td>
      <td>4965.882353</td>
      <td>13.441483</td>
      <td>1.731157</td>
      <td>6.254527</td>
    </tr>
  </tbody>
</table>
<p>631164 rows × 50 columns</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="주가-데이터-표준화" class="level3">
<h3 class="anchored" data-anchor-id="주가-데이터-표준화">2) 주가 데이터 표준화</h3>
<p>주가 데이터의 표준화는 이전에 잘 알려진 <code>minmax</code>, <code>standard</code>, <code>robust</code> 스케일러와, 전날 종가로 나누는 <code>div-close</code> 방법, 총 네 가지 방법을 제공합니다. 네가지 스케일러 모두 주가 관련 컬럼만 스케일링 합니다.</p>
<ul>
<li>minmax</li>
<li>standard</li>
<li>robust</li>
<li>div-close</li>
</ul>
<p>그 중 이 글에서는, <code>div-close</code> 방법을 사용하겠습니다.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>check_scaled_KR <span class="op">=</span> sai.scaling(data<span class="op">=</span>check_df, scaler_type<span class="op">=</span><span class="st">"div-close"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>check_scaled_KR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████████████████████████████████████████████████████| 489/489 [00:19&lt;00:00, 24.99it/s]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Code</th>
      <th>Date</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Change</th>
      <th>MA5</th>
      <th>MA20</th>
      <th>...</th>
      <th>RSI</th>
      <th>SRSI</th>
      <th>TSI</th>
      <th>UO</th>
      <th>SR</th>
      <th>WR</th>
      <th>AO</th>
      <th>ROC</th>
      <th>PPO</th>
      <th>PVO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>2016-06-29</td>
      <td>1.010256</td>
      <td>1.035897</td>
      <td>0.994872</td>
      <td>9750</td>
      <td>352292</td>
      <td>-0.001025</td>
      <td>0.978872</td>
      <td>1.047179</td>
      <td>...</td>
      <td>45.763505</td>
      <td>0.529126</td>
      <td>-8.116135</td>
      <td>0.0</td>
      <td>41.176471</td>
      <td>-58.823529</td>
      <td>-827.794118</td>
      <td>-3.940887</td>
      <td>-1.408719</td>
      <td>-11.019576</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000020</td>
      <td>2016-06-30</td>
      <td>1.010256</td>
      <td>1.066667</td>
      <td>1.001026</td>
      <td>10100</td>
      <td>466248</td>
      <td>0.035897</td>
      <td>0.986462</td>
      <td>1.045641</td>
      <td>...</td>
      <td>51.232344</td>
      <td>0.875363</td>
      <td>-6.553028</td>
      <td>0.0</td>
      <td>54.901961</td>
      <td>-45.098039</td>
      <td>-765.088235</td>
      <td>-2.415459</td>
      <td>-1.124410</td>
      <td>-9.119594</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000020</td>
      <td>2016-07-01</td>
      <td>1.009901</td>
      <td>1.009901</td>
      <td>0.986139</td>
      <td>9960</td>
      <td>208228</td>
      <td>-0.013861</td>
      <td>0.969703</td>
      <td>1.004752</td>
      <td>...</td>
      <td>49.099659</td>
      <td>0.767924</td>
      <td>-5.911240</td>
      <td>0.0</td>
      <td>49.411765</td>
      <td>-50.588235</td>
      <td>-624.205882</td>
      <td>-4.230769</td>
      <td>-1.001426</td>
      <td>-12.558989</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000020</td>
      <td>2016-07-04</td>
      <td>1.004016</td>
      <td>1.044177</td>
      <td>0.993976</td>
      <td>10400</td>
      <td>275210</td>
      <td>0.044177</td>
      <td>1.003414</td>
      <td>1.017620</td>
      <td>...</td>
      <td>55.385557</td>
      <td>1.000000</td>
      <td>-3.312304</td>
      <td>0.0</td>
      <td>66.666667</td>
      <td>-33.333333</td>
      <td>-427.205882</td>
      <td>-0.952381</td>
      <td>-0.541344</td>
      <td>-13.975141</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000020</td>
      <td>2016-07-05</td>
      <td>1.0</td>
      <td>1.004808</td>
      <td>0.980769</td>
      <td>10350</td>
      <td>156010</td>
      <td>-0.004808</td>
      <td>0.972308</td>
      <td>0.972885</td>
      <td>...</td>
      <td>54.560981</td>
      <td>0.961700</td>
      <td>-1.483696</td>
      <td>0.0</td>
      <td>64.705882</td>
      <td>-35.294118</td>
      <td>-266.529412</td>
      <td>1.970443</td>
      <td>-0.216142</td>
      <td>-17.711174</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>29</th>
      <td>383220</td>
      <td>2021-12-23</td>
      <td>1.00339</td>
      <td>1.013559</td>
      <td>0.99322</td>
      <td>176000</td>
      <td>49393</td>
      <td>-0.00565</td>
      <td>1.007006</td>
      <td>0.982881</td>
      <td>...</td>
      <td>50.940761</td>
      <td>0.253349</td>
      <td>4.242959</td>
      <td>0.0</td>
      <td>47.169811</td>
      <td>-52.830189</td>
      <td>739.411765</td>
      <td>1.033295</td>
      <td>0.479735</td>
      <td>-7.390941</td>
    </tr>
    <tr>
      <th>30</th>
      <td>383220</td>
      <td>2021-12-24</td>
      <td>1.006818</td>
      <td>1.006818</td>
      <td>0.934091</td>
      <td>176000</td>
      <td>53197</td>
      <td>0.0</td>
      <td>1.006591</td>
      <td>0.990455</td>
      <td>...</td>
      <td>50.940761</td>
      <td>0.253349</td>
      <td>3.921902</td>
      <td>0.0</td>
      <td>67.441860</td>
      <td>-32.558140</td>
      <td>-27.058824</td>
      <td>0.686499</td>
      <td>0.428087</td>
      <td>-4.519611</td>
    </tr>
    <tr>
      <th>31</th>
      <td>383220</td>
      <td>2021-12-27</td>
      <td>1.011364</td>
      <td>1.028409</td>
      <td>0.997727</td>
      <td>179000</td>
      <td>42262</td>
      <td>0.017045</td>
      <td>1.005682</td>
      <td>0.993580</td>
      <td>...</td>
      <td>55.627962</td>
      <td>0.666579</td>
      <td>4.893728</td>
      <td>0.0</td>
      <td>84.883721</td>
      <td>-15.116279</td>
      <td>347.647059</td>
      <td>1.820250</td>
      <td>0.518392</td>
      <td>-4.275590</td>
    </tr>
    <tr>
      <th>32</th>
      <td>383220</td>
      <td>2021-12-28</td>
      <td>1.006704</td>
      <td>1.060335</td>
      <td>0.996648</td>
      <td>189400</td>
      <td>78018</td>
      <td>0.058101</td>
      <td>1.002682</td>
      <td>0.983464</td>
      <td>...</td>
      <td>67.293872</td>
      <td>1.000000</td>
      <td>9.859346</td>
      <td>0.0</td>
      <td>98.425197</td>
      <td>-1.574803</td>
      <td>1632.941176</td>
      <td>8.975834</td>
      <td>1.049621</td>
      <td>2.260368</td>
    </tr>
    <tr>
      <th>33</th>
      <td>383220</td>
      <td>2021-12-29</td>
      <td>1.01056</td>
      <td>1.053854</td>
      <td>1.01056</td>
      <td>195800</td>
      <td>74152</td>
      <td>0.033791</td>
      <td>0.967476</td>
      <td>0.937592</td>
      <td>...</td>
      <td>72.146913</td>
      <td>1.000000</td>
      <td>16.001174</td>
      <td>0.0</td>
      <td>89.204545</td>
      <td>-10.795455</td>
      <td>4965.882353</td>
      <td>13.441483</td>
      <td>1.731157</td>
      <td>6.254527</td>
    </tr>
  </tbody>
</table>
<p>631164 rows × 50 columns</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="시계열-데이터로-변환" class="level3">
<h3 class="anchored" data-anchor-id="시계열-데이터로-변환">3) 시계열 데이터로 변환</h3>
<p>머신러닝 모델이 예측할 때 D0를 기준으로 그 다음날(D+1)의 종가 변화율을 예측하는데, 독립변수를 기준일(D0)로부터 n일 전의 데이터(D-n, D-n-1, D-n-2, …, D-1, D0)들로 구성하기 위한 변환입니다.</p>
<p>예를 들어, 아래 예제 코드는 이 D0 기준 10일치의 데이터로 변환된 것을 보여줍니다.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_time_series <span class="op">=</span> sai.time_series(check_df, day<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df_time_series_scaled <span class="op">=</span> sai.time_series(check_scaled_KR, day<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>df_time_series_scaled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████████████████████████████████████████████████████| 489/489 [01:41&lt;00:00,  4.83it/s]
100%|█████████████████████████████████████████████████████████████████████████████████████| 489/489 [01:41&lt;00:00,  4.81it/s]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Code</th>
      <th>Date</th>
      <th>D-9_Open</th>
      <th>D-9_High</th>
      <th>D-9_Low</th>
      <th>D-9_Close</th>
      <th>D-9_Volume</th>
      <th>D-9_Change</th>
      <th>D-9_MA5</th>
      <th>D-9_MA20</th>
      <th>...</th>
      <th>D0_SRSI</th>
      <th>D0_TSI</th>
      <th>D0_UO</th>
      <th>D0_SR</th>
      <th>D0_WR</th>
      <th>D0_AO</th>
      <th>D0_ROC</th>
      <th>D0_PPO</th>
      <th>D0_PVO</th>
      <th>next_change</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>2016-07-12</td>
      <td>1.010256</td>
      <td>1.035897</td>
      <td>0.994872</td>
      <td>9750</td>
      <td>352292</td>
      <td>-0.001025</td>
      <td>0.978872</td>
      <td>1.047179</td>
      <td>...</td>
      <td>0.811861</td>
      <td>6.313467</td>
      <td>0.0</td>
      <td>77.083333</td>
      <td>-22.916667</td>
      <td>265.323529</td>
      <td>16.189427</td>
      <td>1.146515</td>
      <td>-6.811964</td>
      <td>-0.009479</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000020</td>
      <td>2016-07-13</td>
      <td>1.010256</td>
      <td>1.066667</td>
      <td>1.001026</td>
      <td>10100</td>
      <td>466248</td>
      <td>0.035897</td>
      <td>0.986462</td>
      <td>1.045641</td>
      <td>...</td>
      <td>0.748510</td>
      <td>6.418054</td>
      <td>0.0</td>
      <td>72.916667</td>
      <td>-27.083333</td>
      <td>359.411765</td>
      <td>11.170213</td>
      <td>1.143441</td>
      <td>-9.808557</td>
      <td>-0.014354</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000020</td>
      <td>2016-07-14</td>
      <td>1.009901</td>
      <td>1.009901</td>
      <td>0.986139</td>
      <td>9960</td>
      <td>208228</td>
      <td>-0.013861</td>
      <td>0.969703</td>
      <td>1.004752</td>
      <td>...</td>
      <td>0.550088</td>
      <td>5.793959</td>
      <td>0.0</td>
      <td>65.957447</td>
      <td>-34.042553</td>
      <td>291.470588</td>
      <td>5.532787</td>
      <td>1.012207</td>
      <td>-13.948242</td>
      <td>-0.019417</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000020</td>
      <td>2016-07-15</td>
      <td>1.004016</td>
      <td>1.044177</td>
      <td>0.993976</td>
      <td>10400</td>
      <td>275210</td>
      <td>0.044177</td>
      <td>1.003414</td>
      <td>1.017620</td>
      <td>...</td>
      <td>0.143497</td>
      <td>4.337998</td>
      <td>0.0</td>
      <td>47.089947</td>
      <td>-52.910053</td>
      <td>180.147059</td>
      <td>3.589744</td>
      <td>0.743307</td>
      <td>-15.318752</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000020</td>
      <td>2016-07-18</td>
      <td>1.000000</td>
      <td>1.004808</td>
      <td>0.980769</td>
      <td>10350</td>
      <td>156010</td>
      <td>-0.004808</td>
      <td>0.972308</td>
      <td>0.972885</td>
      <td>...</td>
      <td>0.143497</td>
      <td>3.148328</td>
      <td>0.0</td>
      <td>28.571429</td>
      <td>-71.428571</td>
      <td>61.705882</td>
      <td>0.000000</td>
      <td>0.523834</td>
      <td>-18.136859</td>
      <td>-0.004950</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>19</th>
      <td>383220</td>
      <td>2021-12-22</td>
      <td>1.006865</td>
      <td>1.021739</td>
      <td>0.996568</td>
      <td>175800</td>
      <td>16927</td>
      <td>0.005721</td>
      <td>1.008009</td>
      <td>1.002574</td>
      <td>...</td>
      <td>0.393969</td>
      <td>4.627357</td>
      <td>0.0</td>
      <td>70.000000</td>
      <td>-30.000000</td>
      <td>317.647059</td>
      <td>0.454030</td>
      <td>0.538685</td>
      <td>-10.077686</td>
      <td>-0.005650</td>
    </tr>
    <tr>
      <th>20</th>
      <td>383220</td>
      <td>2021-12-23</td>
      <td>0.988623</td>
      <td>1.017065</td>
      <td>0.987486</td>
      <td>173800</td>
      <td>16531</td>
      <td>-0.011377</td>
      <td>0.995222</td>
      <td>0.993857</td>
      <td>...</td>
      <td>0.253349</td>
      <td>4.242959</td>
      <td>0.0</td>
      <td>47.169811</td>
      <td>-52.830189</td>
      <td>739.411765</td>
      <td>1.033295</td>
      <td>0.479735</td>
      <td>-7.390941</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>383220</td>
      <td>2021-12-24</td>
      <td>1.005754</td>
      <td>1.009206</td>
      <td>0.990794</td>
      <td>172600</td>
      <td>16918</td>
      <td>-0.006904</td>
      <td>1.002532</td>
      <td>1.003337</td>
      <td>...</td>
      <td>0.253349</td>
      <td>3.921902</td>
      <td>0.0</td>
      <td>67.441860</td>
      <td>-32.558140</td>
      <td>-27.058824</td>
      <td>0.686499</td>
      <td>0.428087</td>
      <td>-4.519611</td>
      <td>0.017045</td>
    </tr>
    <tr>
      <th>22</th>
      <td>383220</td>
      <td>2021-12-27</td>
      <td>1.000000</td>
      <td>1.016222</td>
      <td>0.990730</td>
      <td>173000</td>
      <td>18613</td>
      <td>0.002317</td>
      <td>1.008111</td>
      <td>1.007532</td>
      <td>...</td>
      <td>0.666579</td>
      <td>4.893728</td>
      <td>0.0</td>
      <td>84.883721</td>
      <td>-15.116279</td>
      <td>347.647059</td>
      <td>1.820250</td>
      <td>0.518392</td>
      <td>-4.275590</td>
      <td>0.058101</td>
    </tr>
    <tr>
      <th>23</th>
      <td>383220</td>
      <td>2021-12-28</td>
      <td>1.000000</td>
      <td>1.011561</td>
      <td>0.991908</td>
      <td>174000</td>
      <td>18350</td>
      <td>0.005780</td>
      <td>1.004855</td>
      <td>1.004104</td>
      <td>...</td>
      <td>1.000000</td>
      <td>9.859346</td>
      <td>0.0</td>
      <td>98.425197</td>
      <td>-1.574803</td>
      <td>1632.941176</td>
      <td>8.975834</td>
      <td>1.049621</td>
      <td>2.260368</td>
      <td>0.033791</td>
    </tr>
  </tbody>
</table>
<p>626274 rows × 473 columns</p>
</div>
</div>
</div>
<p><br></p>
<p>데이터의 크기가 크면, 위의 세가지 전처리 과정이 오래 걸릴 수 있습니다. 따라서 아래와 같이 데이터를 저장하고, 불러오는 방식을 추천합니다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_time_series.to_parquet(<span class="st">"time_series.parquet"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>df_time_series_scaled.to_parquet(<span class="st">"time_series_scaled.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_time_series <span class="op">=</span> pd.read_parquet(<span class="st">"time_series.parquet"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>df_time_series_scaled <span class="op">=</span> pd.read_parquet(<span class="st">"time_series_scaled.parquet"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>df_time_series[<span class="st">'Code'</span>] <span class="op">=</span> df_time_series[<span class="st">'Code'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">6</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>df_time_series_scaled[<span class="st">'Code'</span>] <span class="op">=</span> df_time_series_scaled[<span class="st">'Code'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>이제 학습, 시험데이터셋을 분리하겠습니다. 2016년부터 2021년까지의 데이터를 불러왔었는데, 2016년의 데이터는 보조지표 추가를 위해 임시로 불러온 것이므로 <strong>2017년~2020년</strong>을 <strong>학습데이터셋</strong>, <strong>2021년</strong>을 <strong>시험 데이터셋</strong>으로 저장해주었습니다.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> df_time_series <span class="co"># Data Before Scaling</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>data_scaled <span class="op">=</span> df_time_series_scaled <span class="co"># Data After Scaling</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># train, test dataset split</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> data[(data[<span class="st">'Date'</span>] <span class="op">&gt;=</span> <span class="st">'2017-01-01'</span>) <span class="op">&amp;</span> (data[<span class="st">'Date'</span>] <span class="op">&lt;=</span> <span class="st">'2020-12-31'</span>)]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> data[(data[<span class="st">'Date'</span>] <span class="op">&gt;=</span> <span class="st">'2021-01-01'</span>) <span class="op">&amp;</span> (data[<span class="st">'Date'</span>] <span class="op">&lt;=</span> <span class="st">'2021-12-31'</span>)]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># train, test dataset split (scaled) </span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="op">=</span> data_scaled[(data_scaled[<span class="st">'Date'</span>] <span class="op">&gt;=</span> <span class="st">'2017-01-01'</span>) <span class="op">&amp;</span> (data_scaled[<span class="st">'Date'</span>] <span class="op">&lt;=</span> <span class="st">'2020-12-31'</span>)]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="op">=</span> data_scaled[(data_scaled[<span class="st">'Date'</span>] <span class="op">&gt;=</span> <span class="st">'2021-01-01'</span>) <span class="op">&amp;</span> (data_scaled[<span class="st">'Date'</span>] <span class="op">&lt;=</span> <span class="st">'2021-12-31'</span>)]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_data.shape, test_data.shape)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_data_scaled.shape, test_data_scaled.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(828290, 483) (217159, 483)
(828290, 483) (217159, 483)</code></pre>
</div>
</div>
<p><br> <br></p>
</section>
</section>
<section id="트레이더-정의" class="level1">
<h1>3. 트레이더 정의</h1>
<p><code>트레이더</code>라는 개념을 사용합니다. 인공지능 모델 학습, 평가, 수익률 계산은 모두 <code>트레이더</code>를 통해 진행됩니다. 따라서, 위의 과정을 수행하기 위해 <code>트레이더</code>를 먼저 정의해야합니다.</p>
<ul>
<li>트레이더는 크게 (1) <code>buyer</code> (매수객체) 와 (2) <code>seller</code> (매도객체) 를 갖습니다.
<ul>
<li><ol type="1">
<li><code>Buyer</code>는 매수를 위한 객체이며, (1.1) <code>conditional_buyer</code> 와 (1.2) <code>machine learning_buyer</code> 가 존재합니다.</li>
</ol>
<ul>
<li>(1.1) <code>conditional_buyer</code> 데이터 필터링 조건으로 매수를 결정하는 객체입니다.</li>
<li>(1.2) <code>machine learning_buyer</code> 머신러닝 모델을 사용하여 학습하고, 매수를 결정하는 객체이며, 모델을 정의하고 학습하는 역할을 합니다.</li>
<li>마지막으로 위의 (1.1), (1.2) 의 조건을 결합하여 매수를 결정합니다.</li>
</ul></li>
<li><ol start="2" type="1">
<li><code>Seller</code> 는 매도객체입니다. 기본적으로, <code>Seller</code>에 <code>SubSeller</code>객체를 넣어주면, 다음날에 모두 매도하는 것으로 설정됩니다.</li>
</ol></li>
</ul></li>
</ul>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List containing trader objects </span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># You can put a bunch of traders in here, and you can trade at once. </span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># See 'tutorials/01.trader_definition.ipynb' for a detailed example.</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>lst_trader <span class="op">=</span> [] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightgbm <span class="im">import</span> LGBMClassifier</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># conditional_buyer: Object that determines acquisition based on data filtering conditions </span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>b1_lg <span class="op">=</span> sai.ConditionalBuyer()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sampling1(df): <span class="co"># Create a conditional function</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    condition1 <span class="op">=</span> (<span class="op">-</span><span class="fl">0.3</span> <span class="op">&lt;=</span> df.D0_Change) <span class="op">&amp;</span> (df.D0_Change <span class="op">&lt;=</span> <span class="fl">0.3</span>) <span class="co"># Remove exceptions that exceed upper and lower limits</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    condition2 <span class="op">=</span> (df.D0_Close <span class="op">*</span> df.D0_Volume) <span class="op">&gt;=</span> <span class="dv">1000000000</span> <span class="co"># condition 1: Transaction amount of more than 1 billion won </span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    condition3 <span class="op">=</span> (<span class="op">-</span><span class="fl">0.05</span> <span class="op">&gt;=</span> df.D0_Change) <span class="op">|</span> (<span class="fl">0.05</span> <span class="op">&lt;=</span> df.D0_Change) <span class="co"># condition 2: Today's stock price change rate is more than 5%</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    condition <span class="op">=</span> condition1 <span class="op">&amp;</span> condition2 <span class="op">&amp;</span> condition3</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> condition</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>b1_lg.condition <span class="op">=</span> sampling1  <span class="co"># Define the condition function directly (sampling1) and store it in the condition property </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># machinelearning_buyer: Object that determines acquisition by machine learning model</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>b2_lg <span class="op">=</span> sai.MachinelearningBuyer()</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Save user-defined models to algorithm properties</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>scale_pos_weight <span class="op">=</span> <span class="bu">round</span>(<span class="dv">72</span><span class="op">/</span><span class="dv">28</span> , <span class="dv">2</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {  <span class="st">'random_state'</span> : <span class="dv">42</span>,</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'scale_pos_weight'</span> : scale_pos_weight,</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'learning_rate'</span> : <span class="fl">0.1</span>, </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_iterations'</span> : <span class="dv">1000</span>,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'max_depth'</span> : <span class="dv">4</span>,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_jobs'</span> : <span class="dv">30</span>,</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">'boost_from_average'</span> : <span class="va">False</span>,</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">'objective'</span> : <span class="st">'binary'</span> }</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>b2_lg.algorithm <span class="op">=</span>  LGBMClassifier( <span class="op">**</span>params )</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co"># SubSeller: Object that determines selling all of the following days</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>sell_all <span class="op">=</span> sai.SubSeller() </span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Trader Object   </span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> sai.Trader()</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>t1.name <span class="op">=</span> <span class="st">'saiLightGBM'</span> <span class="co"># Trader's name</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>t1.label <span class="op">=</span> <span class="st">'class&amp;0.02'</span> <span class="co"># Set the Trader dependent variable (do not set if it is regression analysis) </span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>t1.buyer <span class="op">=</span> sai.Buyer([b1_lg, b2_lg]) <span class="co"># [ conditional buyer, machinelearning buyer ] </span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>t1.seller <span class="op">=</span> sai.Seller(sell_all)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>lst_trader.append(t1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br> <br></p>
</section>
<section id="트레이더-사용-모델-학습-및-평가" class="level1">
<h1>4. 트레이더 사용 (모델 학습 및 평가)</h1>
<blockquote class="blockquote">
<p>1) 트레이더에 데이터셋 저장: <code>sai.save_dataset(lst_trader:list, train_data:pd.DataFrame(), test_data:pd.DataFrame(), train_data_scaled:pd.DataFrame()=None, test_data_scaled:pd.DataFrame()=None)</code><br>
2) 모델 학습: <code>sai.trader_train(lst_trader:list)</code><br>
3) 모델 평가 및 임계값 설정: <code>sai.get_eval_by_threshold(lst_trader)</code>, <code>sai.set_threshold(lst_trader, lst_threshold:list, hisogram:bool=True)</code></p>
</blockquote>
<p><br></p>
<section id="트레이더에-데이터셋-저장" class="level3">
<h3 class="anchored" data-anchor-id="트레이더에-데이터셋-저장">1) 트레이더에 데이터셋 저장</h3>
<p>트레이더 객체가 저장된 리스트와 학습, 시험 데이터셋을 인자에 넣어줍니다. 이 때, 앞서 표준화를 진행했다면, 표준화된 데이터셋도 함께 넣어줍니다.</p>
<p><strong>[Types of Data Stored]</strong> - 원본 데이터셋 (training/test, 독립변수 / 종속변수_regression / 종속변수_classification) - 표준화 데이터셋 (training/test, 독립변수 / 종속변수_regression / 종속변수_classification)</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sai.save_dataset(lst_trader, train_data, test_data, train_data_scaled, test_data_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== saiLightGBM ==
== train_code_date: (828290, 2),  test_code_date: (217159, 2) ==
== trainX: (828290, 480),  testX: (217159, 480) ==
== trainX_scaled: (828290, 480),  testX_scaled: (217159, 480) ==
== trainY: (828290,),  testY: (217159,) ==
== trainY_classification: (828290,),  testY_classification: (217159,) ==
</code></pre>
</div>
</div>
<p>saiLightGBM 객체에 모델 학습 및 평가에 필요한 데이터셋들을 생성하여 저장합니다.</p>
<p><br></p>
</section>
<section id="모델-학습" class="level3">
<h3 class="anchored" data-anchor-id="모델-학습">2) 모델 학습</h3>
<p>모델 학습은 각각의 트레이더에 저장된 데이터셋과 머신러닝 모델로 이루어집니다.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sai.trader_train(lst_trader) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== saiLightGBM Model Fitting Completed ==</code></pre>
</div>
</div>
<p>앞서 설정한 조건들, 머신러닝 모델, 저장된 데이터셋으로 LightGBM 모델이 학습되었습니다.</p>
<p><br></p>
</section>
<section id="모델-평가-및-임계값-설정" class="level3">
<h3 class="anchored" data-anchor-id="모델-평가-및-임계값-설정">3) 모델 평가 및 임계값 설정</h3>
<section id="모델-평가" class="level4">
<h4 class="anchored" data-anchor-id="모델-평가">모델 평가</h4>
<p>네가지의 지표가 모델 성능 평가에 사용됩니다. (auc score, precision, recall, f1 score)<br>
특히, 두번째 그래프는 모델의 예측 확률 임계값 별 평가지표인데, 점점 증가하는 precision을 유의깊게 확인하여 아래의 임계값 설정에 참고합니다.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>sai.get_eval_by_threshold(lst_trader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="s00.demo_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>오른쪽 그래프에서 빨간 선이 정밀도입니다. 이 예시에서는 정밀도가 조금씩 점점 상승하다 0.6쯤 부터 눈에 띄게 상승하고, 임계값이 0.8일 때 다시 하락하는 추이를 보입니다. 특정 threshold, 즉 특정 예측 확률이상일 때 정밀도가 증가하면 해당 집단에서 예측이 잘 되어진다는 소리이므로, 그러한 threshold를 적절히 설정해주도록 합니다.</p>
<p><br></p>
</section>
<section id="임계값-설정" class="level4">
<h4 class="anchored" data-anchor-id="임계값-설정">임계값 설정</h4>
<p>주식의 매수를 결정하기 위해, machinelearning_buyer 객체의 threshold를 설정해야 합니다. 여기서 threshold는 머신러닝 모델의 예측 확률 임계값입니다. 우리가 학습시킨 머신러닝 모델을 예로 들어, 다음 날 종가 0.2%이상일 예측확률이 80% 이상인 날짜에만 매수하게끔 하려면, threshold를 0.8로 설정해주는 것입니다. 아래의 set_threshold 함수 결과로 나오는 히스토그램을 보고 threshold를 결정합니다. 빨간색 그래프가 임계값 이상인 next_change 값으로, 수익성을 검증해보며 판단할 수 있습니다. lst_threshold 인자에 각 트레이더의 순서대로 임계값을 넣어주면 그에 맞는 히스토그램이 그려지고, machinelearning_buyer의 threshold도 설정이 됩니다.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>sai.set_threshold(lst_trader, lst_threshold<span class="op">=</span>[<span class="fl">0.8</span>], histogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error: local variable 'threshold' referenced before assignment</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 1152x720 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 1152x720 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="s00.demo_files/figure-html/cell-18-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>앞선 모델 평가에서 정밀도의 추이를 보고 threshold를 설정하게 되는데, 예시로 0.8일 때로 잡고, 히스토그램을 그려본 결과입니다. 예측확률이 0.8 이상일 때의 집단의 y값인 next_change값의 평균이 그렇지 않은 집단의 평균보다 높았습니다. 임계값 0.8 이상일 때 데이터들로만 매수를 결정하면 수익률 2.948 정도를 기대할 수 있습니다.</p>
<p><br> <br></p>
</section>
</section>
</section>
<section id="수익률-시뮬레이션" class="level1">
<h1>4. 수익률 시뮬레이션</h1>
<blockquote class="blockquote">
<p>1) 매매일지 작성: <code>sai.decision(lst_trader:list, dtype='test', data=None, data_scaled=None)</code><br>
2) 수익률 시뮬레이션: Calculate the yield: <code>sai.simulation(df_signal_all, init_budget, init_stock)</code><br>
3) 수익률 리더보드: <code>sai.leaderboard(df)</code><br>
4) 수익률 시각화 결과: <code>sai.yield_plot(df)</code></p>
</blockquote>
<p><br></p>
<section id="매매일지-작성" class="level3">
<h3 class="anchored" data-anchor-id="매매일지-작성">1) 매매일지 작성</h3>
<p>각 트레이더에 대한 매매일지를 작성하고, 이를 하나의 데이터프레임에 결합합니다. 매매일지는 모든 날짜에 대하여 작성되며, Amount는 매수/매도 비율을 의미합니다. (0: 매수/매도 X, 1: 모두 매수/매도)</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_signal_all <span class="op">=</span> sai.decision(lst_trader, dtype<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>df_signal_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>217159it [00:06, 35561.35it/s]
217159it [00:06, 35990.93it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>== saiLightGBM completed ==</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Trader_id</th>
      <th>Date</th>
      <th>Code</th>
      <th>+(buy)/-(sell)</th>
      <th>Amount</th>
      <th>Close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>saiLightGBM</td>
      <td>2021-01-04</td>
      <td>000020</td>
      <td>+</td>
      <td>0.0</td>
      <td>19100.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>saiLightGBM</td>
      <td>2021-01-05</td>
      <td>000020</td>
      <td>+</td>
      <td>0.0</td>
      <td>19400.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>saiLightGBM</td>
      <td>2021-01-06</td>
      <td>000020</td>
      <td>+</td>
      <td>0.0</td>
      <td>19700.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>saiLightGBM</td>
      <td>2021-01-07</td>
      <td>000020</td>
      <td>+</td>
      <td>0.0</td>
      <td>19700.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>saiLightGBM</td>
      <td>2021-01-08</td>
      <td>000020</td>
      <td>+</td>
      <td>0.0</td>
      <td>19100.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>217154</th>
      <td>saiLightGBM</td>
      <td>2021-12-24</td>
      <td>009900</td>
      <td>-</td>
      <td>1.0</td>
      <td>30600.0</td>
    </tr>
    <tr>
      <th>217155</th>
      <td>saiLightGBM</td>
      <td>2021-12-27</td>
      <td>009900</td>
      <td>-</td>
      <td>1.0</td>
      <td>29900.0</td>
    </tr>
    <tr>
      <th>217156</th>
      <td>saiLightGBM</td>
      <td>2021-12-28</td>
      <td>009900</td>
      <td>-</td>
      <td>1.0</td>
      <td>29400.0</td>
    </tr>
    <tr>
      <th>217157</th>
      <td>saiLightGBM</td>
      <td>2021-12-29</td>
      <td>009900</td>
      <td>-</td>
      <td>1.0</td>
      <td>29850.0</td>
    </tr>
    <tr>
      <th>217158</th>
      <td>saiLightGBM</td>
      <td>2021-12-30</td>
      <td>009900</td>
      <td>-</td>
      <td>1.0</td>
      <td>30100.0</td>
    </tr>
  </tbody>
</table>
<p>434318 rows × 6 columns</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="simulation-수익률-계산" class="level3">
<h3 class="anchored" data-anchor-id="simulation-수익률-계산">2) Simulation: 수익률 계산</h3>
<p>매매일지를 기반으로, 각 트레이더 별로 수익률을 계산합니다.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_history_all <span class="op">=</span> sai.simulation(df_signal_all, init_budget<span class="op">=</span><span class="dv">10000000</span>, init_stock<span class="op">=</span>{})</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>df_history_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████████████████████████████████████████████████████████▌| 247/248 [00:07&lt;00:00, 33.85it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>== saiLightGBM completed ==</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Trader_id</th>
      <th>Sell_date</th>
      <th>Budget</th>
      <th>Yield</th>
      <th>Stock</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>saiLightGBM</td>
      <td>2021-01-04</td>
      <td>10000000</td>
      <td>0.000000</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>1</th>
      <td>saiLightGBM</td>
      <td>2021-01-05</td>
      <td>10000000</td>
      <td>0.000000</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>2</th>
      <td>saiLightGBM</td>
      <td>2021-01-06</td>
      <td>10000000</td>
      <td>0.000000</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>3</th>
      <td>saiLightGBM</td>
      <td>2021-01-07</td>
      <td>10000000</td>
      <td>0.000000</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>4</th>
      <td>saiLightGBM</td>
      <td>2021-01-08</td>
      <td>10000000</td>
      <td>0.000000</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>saiLightGBM</td>
      <td>2021-12-24</td>
      <td>14442372</td>
      <td>44.423725</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>244</th>
      <td>saiLightGBM</td>
      <td>2021-12-27</td>
      <td>14442372</td>
      <td>44.423725</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>245</th>
      <td>saiLightGBM</td>
      <td>2021-12-28</td>
      <td>14442372</td>
      <td>44.423725</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>246</th>
      <td>saiLightGBM</td>
      <td>2021-12-29</td>
      <td>14442372</td>
      <td>44.423725</td>
      <td>{}</td>
    </tr>
    <tr>
      <th>247</th>
      <td>saiLightGBM</td>
      <td>2021-12-30</td>
      <td>14442372</td>
      <td>44.423725</td>
      <td>{}</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 5 columns</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="리더보드" class="level3">
<h3 class="anchored" data-anchor-id="리더보드">3) 리더보드</h3>
<p>각 트레이더의 계산된 수익률을 내림차순으로 보여줍니다. 즉, 이 리더보드는 트레이더 수익률의 순위를 나타냅니다.</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>sai.leaderboard(df_history_all)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Trader_id</th>
      <th>Yield</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>saiLightGBM</td>
      <td>44.423725</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="시각화-결과" class="level3">
<h3 class="anchored" data-anchor-id="시각화-결과">4) 시각화 결과</h3>
<p>날짜 별 각 트레이더의 수익률 변화를 볼 수 있습니다.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>sai.yield_plot(df_history_all)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="s00.demo_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>