<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="agsu">
<meta name="dcterms.date" content="2022-07-25">

<title>Data Analysis blog - [stock prediction] 3.3 클러스터 탐색을 통한 주가상승 패턴 검출</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Data Analysis blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ag-su"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://agsu.tistory.com/"><i class="bi bi-box2-heart" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">[stock prediction] 3.3 클러스터 탐색을 통한 주가상승 패턴 검출</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">project</div>
                <div class="quarto-category">stock prediction</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>agsu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 25, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="논문-연구-주가상승-패턴-검출" class="level1">
<h1>3. 논문 연구: 주가상승 패턴 검출</h1>
<section id="클러스터-탐색을-통한-주가상승-패턴-검출" class="level2">
<h2 class="anchored" data-anchor-id="클러스터-탐색을-통한-주가상승-패턴-검출">3.3. 클러스터 탐색을 통한 주가상승 패턴 검출</h2>
<p>지난 글 ( <a href="https://ag-su.github.io/blog/posts/06.tsne.html">3.2 t-SNE를 사용한 주가데이터 2차원 시각화</a> ) 에서는 원본 주가데이터셋과 SHAP 표준화 데이터셋에 대한 t-SNE 2차원 산점도 시각화를 수행하여 SHAP 표준화 데이터셋의 군집의 경계가 더 명확하게 드러남을 확인하였습니다. 이번 글에서는 <code>SHAP 표준화 데이터셋</code>에 <code>계층적 클러스터링</code> 알고리즘을 적용하여 명시적으로 군집을 분류해보고, label1의 비율로 군집을 필터링하여 <code>상승 추세 군집</code>을 선택합니다. 선택된 상승 추세 군집에서 빈도수 상위 날짜들의 개별 종목 차트를 확인하여 <code>공통된 패턴을 검출</code>합니다.</p>
<section id="목차" class="level3">
<h3 class="anchored" data-anchor-id="목차">목차</h3>
<ul>
<li><ol type="1">
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택<br>
</li>
</ol></li>
<li><ol start="2" type="1">
<li>정리</li>
</ol></li>
<li>라이브러리 import</li>
</ul>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymysql</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ipywidgets <span class="im">import</span> interact, interact_manual</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.offline <span class="im">as</span> pyo</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pylab inline</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>pylab.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">5</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.unicode_minus'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'font'</span>, family<span class="op">=</span><span class="st">'NanumGothic'</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> StockFunc <span class="im">as</span> sf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>%pylab is deprecated, use %matplotlib inline and import the required libraries.
Populating the interactive namespace from numpy and matplotlib</code></pre>
</div>
</div>
<p><br> <br></p>
</section>
</section>
<section id="계층적-클러스터링-상승-추세-군집-선택" class="level2">
<h2 class="anchored" data-anchor-id="계층적-클러스터링-상승-추세-군집-선택">(1) 계층적 클러스터링 &amp; 상승 추세 군집 선택</h2>
<p><code>상승 추세 군집</code>이란 <strong>기준일 (D0) 대비 다음 날 (D+1) 종가 2% 이상 상승</strong>한 데이터들이 일정 비율 이상 속하는 군집들을 의미합니다. 계층적 클러스터링을 통해 생성된 군집들을 label1의 비율로 필터링하여 상승 추세 군집을 선택합니다.</p>
<ul>
<li>linkage, 덴드로그램 시각화 함수</li>
</ul>
<p>계층적 클러스터링에서의 덴드로그램 시각화를 수행하여 트리의 높이를 결정할 수 있도록 합니다.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hierarchical_clustering_plot(method, year, cci_type, dendrogram<span class="op">=</span><span class="va">False</span>, n_clusters<span class="op">=</span><span class="dv">5</span>, min_samples<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, size<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    method: str / complete, average, ward</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    year: int / 2019, 2020, 2021</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    cci_type:int / 1, 2, 3</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    dendrogram:Boolean / True, False(default) - 시간이 오래걸리므로 선택 </span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    n_clusters: int / default:5</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    min_samples: int / default:5</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha: float / default: 0.3</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    size: int / default: 4</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pickle <span class="co"># tsne 파일 불러오기 </span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f'np_tsne_shap_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>cci_type<span class="sc">}</span><span class="ss">'</span>, <span class="st">'rb'</span>) <span class="im">as</span> handle: </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        np_tsne <span class="op">=</span> pickle.load(handle)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="kw">in</span> (<span class="st">'complete'</span>, <span class="st">'average'</span>, <span class="st">'ward'</span>): <span class="co"># linkage method 선택 </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> scipy.cluster.hierarchy <span class="im">import</span> linkage, dendrogram</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        clusters <span class="op">=</span> linkage(y<span class="op">=</span>np_tsne, method<span class="op">=</span>method, metric<span class="op">=</span><span class="st">'euclidean'</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"linkage complete"</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dendrogram: <span class="co"># True: 덴드로그램 시각화 </span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>            plt.title(<span class="ss">f"</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> dendrogram"</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            dendrogram(clusters, leaf_rotation<span class="op">=</span><span class="dv">90</span>, leaf_font_size<span class="op">=</span><span class="dv">12</span>,)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            plt.show() </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> clusters </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"method를 잘못 입력하였습니다."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>계층적 클러스터링, 상승 추세 군집 선택 시각화</li>
</ul>
<p>덴드로그램을 참고하여 <code>40 ~ 60개의 군집</code>이 형성되도록 t를 설정합니다. 상승 추세 군집을 선택하기 위해 적절한 ratio(특정 집단에서의 label1의 비율)값을 지정해주는데, <code>군집의 개수는 4 ~ 10개</code>, <code>데이터의 개수는 3000 ~ 6000개</code> 사이가 되도록 설정합니다.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fcluster_plot_and_filtering(np_clusters, year, cci_type, t<span class="op">=</span><span class="dv">30</span>, ratio<span class="op">=</span><span class="fl">0.5</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, size<span class="op">=</span><span class="dv">4</span>, xlim<span class="op">=</span><span class="dv">70</span>, ylim<span class="op">=</span><span class="dv">70</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    np_clusters: np.array</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    year: int / 2019, 2020, 2021</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    cci_type: int / 1, 2, 3 </span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    t: int / default: 30 (덴드로그램 트리의 높이) </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ratio: float / default:0.5 (1의 비율이 지정)  </span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.cluster.hierarchy <span class="im">import</span> fcluster <span class="co"># 지정한 클러스터 자르기</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pickle     </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'all_dataset'</span>, <span class="st">'rb'</span>) <span class="im">as</span> handle: <span class="co"># Code, Date, Label 정보가 모두 들어있는 데이터셋 불러오기</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        dict_all_dataset <span class="op">=</span> pickle.load(handle)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f'np_tsne_shap_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>cci_type<span class="sc">}</span><span class="ss">'</span>, <span class="st">'rb'</span>) <span class="im">as</span> handle: <span class="co"># 연도, CCI 구간에 맞는 tsne 데이터셋 불러오기</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        np_tsne <span class="op">=</span> pickle.load(handle)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    df_shap_cci <span class="op">=</span> dict_all_dataset[cci_type][<span class="dv">1</span>]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    df_shap_year <span class="op">=</span> df_shap_cci[(df_shap_cci[<span class="st">'Date'</span>] <span class="op">&gt;=</span> <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-01-01'</span>) <span class="op">&amp;</span> (df_shap_cci[<span class="st">'Date'</span>] <span class="op">&lt;=</span> <span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-12-31'</span>)].reset_index(drop<span class="op">=</span><span class="va">True</span>) <span class="co"># 연도에 맞는 데이터 필터링</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    cut_tree <span class="op">=</span> fcluster(np_clusters, t<span class="op">=</span>t, criterion<span class="op">=</span><span class="st">'distance'</span>) <span class="co"># 군집화 결과 데이터 </span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"군집의 개수:"</span>, <span class="bu">len</span>(pd.DataFrame(cut_tree)[<span class="dv">0</span>].unique())) <span class="co"># 군집의 개수 출력 </span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### 클러스터링 시각화 </span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    ax1, ax2 <span class="op">=</span> fig.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    scatter <span class="op">=</span> ax1.scatter(x<span class="op">=</span>np_tsne[:, <span class="dv">0</span>], y<span class="op">=</span>np_tsne[:, <span class="dv">1</span>], c<span class="op">=</span>cut_tree, cmap<span class="op">=</span><span class="st">'gist_rainbow'</span>, alpha<span class="op">=</span>alpha, s<span class="op">=</span>size) <span class="co"># 군집(cut_tree)별로 시각화 </span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    ax1.legend(<span class="op">*</span>scatter.legend_elements())</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f"</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> Hierarchical Clustering"</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### 라벨 1의 비율을 사용한 클러스터 필터링: 상승 추세 군집 선택</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    df_tsne <span class="op">=</span> pd.DataFrame(np_tsne, columns<span class="op">=</span>[<span class="st">'component1'</span>, <span class="st">'component2'</span>])</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    df_tsne[<span class="st">'Code'</span>], df_tsne[<span class="st">'Date'</span>], df_tsne[<span class="st">'Label'</span>], df_tsne[<span class="st">'Cluster'</span>] <span class="op">=</span> df_shap_year[<span class="st">'Code'</span>], df_shap_year[<span class="st">'Date'</span>], df_shap_year[<span class="st">'Label'</span>], cut_tree</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    gb <span class="op">=</span> df_tsne.groupby(<span class="st">'Cluster'</span>)[<span class="st">'Label'</span>].value_counts(sort<span class="op">=</span><span class="va">False</span>).unstack() <span class="co"># 군집 별 라벨 개수</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    idx_label_1 <span class="op">=</span> gb[gb[<span class="dv">1</span>]<span class="op">/</span>(gb[<span class="dv">0</span>]<span class="op">+</span>gb[<span class="dv">1</span>]) <span class="op">&gt;</span> ratio].index <span class="co"># label 1의 비율이 ratio 이상인 군집 번호</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'label 1 &gt; </span><span class="sc">{</span>ratio<span class="sc">}</span><span class="ss"> 군집 번호: '</span>, idx_label_1)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    df_tsne_1 <span class="op">=</span> df_tsne[df_tsne[<span class="st">'Cluster'</span>].isin(idx_label_1)] <span class="co"># 라벨 1의 비율이 ratio 이상인 군집 추출 (상승 추세 군집)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"데이터의 개수:"</span>, <span class="bu">len</span>(df_tsne_1))</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"종목의 종류:"</span>, df_tsne_1[<span class="st">'Code'</span>].nunique(), <span class="st">" | "</span>, <span class="st">"날짜의 종류: "</span>, df_tsne_1[<span class="st">'Date'</span>].nunique())</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### 상승 추세 군집 시각화 </span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="ss">f"label 1 &gt; </span><span class="sc">{</span>ratio<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    scatter <span class="op">=</span> ax2.scatter(df_tsne_1[<span class="st">'component1'</span>],df_tsne_1[<span class="st">'component2'</span>],c<span class="op">=</span>df_tsne_1[<span class="st">'Cluster'</span>], cmap<span class="op">=</span><span class="st">'gist_rainbow'</span>, s<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    ax2.legend(<span class="op">*</span>scatter.legend_elements())</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylim(<span class="op">-</span>ylim, ylim) <span class="co"># tsne 범위와 맞추기</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlim(<span class="op">-</span>xlim, xlim)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_shap_year, df_tsne_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>주 컬럼</strong> 생성 및 <strong>빈도수 상위 주</strong> 시각화 함수</li>
</ul>
<p><strong>[주 컬럼 생성 참고]</strong><br>
-<a href="https://soooprmx.com/python-%EA%B7%B8-%EB%82%A0%EC%A7%9C%EA%B0%80-%EB%AA%87-%EC%A3%BC%EC%A7%B8%EC%9D%B8%EC%A7%80-%EA%B3%84%EC%82%B0%ED%95%98%EA%B8%B0/">(Python) 그 날짜가 몇 주째인지 계산하기</a></p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualization_week(data_list, week_num<span class="op">=</span><span class="dv">3</span>, day_num<span class="op">=</span><span class="dv">5</span>): <span class="co"># 빈도수 상위 주 시각화 </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### 주 컬럼 생성</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_week_no(target):  </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> datetime <span class="im">import</span> timedelta</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        firstday <span class="op">=</span> target.replace(day<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> firstday.weekday() <span class="op">==</span> <span class="dv">6</span>:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            origin <span class="op">=</span> firstday</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> firstday.weekday() <span class="op">&lt;</span> <span class="dv">3</span>:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            origin <span class="op">=</span> firstday <span class="op">-</span> timedelta(days<span class="op">=</span>firstday.weekday() <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            origin <span class="op">=</span> firstday <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">6</span><span class="op">-</span>firstday.weekday())</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span>target<span class="sc">.</span>month<span class="sc">}</span><span class="ss">월 </span><span class="sc">{</span>(target <span class="op">-</span> origin)<span class="sc">.</span>days <span class="op">//</span> <span class="dv">7</span> <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">주차'</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    mpl.rcParams[<span class="st">'font.family'</span>] <span class="op">=</span> <span class="st">'NanumSquare'</span>    </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">5</span>))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> fig.subplots(<span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    lst_year <span class="op">=</span> [<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### 연도 별 상위 빈도수 주, 날짜 시각화 </span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, data <span class="kw">in</span> <span class="bu">enumerate</span>(data_list): <span class="co"># 연도 별 데이터셋 </span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(data[<span class="st">'Date'</span>]).dt.date <span class="co"># datetime type 변경 </span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">'date_month_week'</span>] <span class="op">=</span> data[<span class="st">'Date'</span>].<span class="bu">apply</span>(get_week_no) <span class="co"># xx월 xx주차 컬럼 생성 </span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        df_week <span class="op">=</span> pd.DataFrame(data[<span class="st">'date_month_week'</span>].value_counts().head(week_num)).reset_index().rename(columns<span class="op">=</span>{<span class="st">'index'</span>:<span class="st">'month-week'</span>, <span class="st">'date_month_week'</span>:<span class="st">'count'</span>}) <span class="co"># 빈도수 상위 주차 5개 </span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        df_day <span class="op">=</span> pd.DataFrame(data[<span class="st">'Date'</span>].value_counts().head(day_num)).reset_index().rename(columns<span class="op">=</span>{<span class="st">'index'</span>:<span class="st">'Date'</span>, <span class="st">'Date'</span>:<span class="st">'count'</span>}) <span class="co"># 빈도수 상위 주차 5개 </span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>, i].set_title(<span class="ss">f"&lt;</span><span class="sc">{</span>lst_year[i]<span class="sc">}</span><span class="ss">년 빈도수 상위 주&gt;"</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        sns.barplot(data<span class="op">=</span>df_week, x<span class="op">=</span><span class="st">'count'</span>, y<span class="op">=</span><span class="st">'month-week'</span>, palette<span class="op">=</span><span class="st">"Pastel1"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>, i])</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> height, p <span class="kw">in</span> <span class="bu">enumerate</span>(ax[<span class="dv">0</span>, i].patches):</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> p.get_width()</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>, i].text(width, height<span class="op">+</span><span class="fl">0.2</span>, <span class="ss">f'</span><span class="sc">{</span><span class="bu">round</span>(p.get_width())<span class="sc">}</span><span class="ss">'</span>, ha <span class="op">=</span> <span class="st">'center'</span>, size <span class="op">=</span> <span class="dv">13</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">1</span>, i].set_title(<span class="ss">f"&lt;</span><span class="sc">{</span>lst_year[i]<span class="sc">}</span><span class="ss">년 빈도수 상위 날짜&gt;"</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        sns.barplot(data<span class="op">=</span>df_day, x<span class="op">=</span><span class="st">'count'</span>, y<span class="op">=</span><span class="st">'Date'</span>, palette<span class="op">=</span><span class="st">"Pastel1"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>, i])</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> height, p <span class="kw">in</span> <span class="bu">enumerate</span>(ax[<span class="dv">1</span>, i].patches):</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> p.get_width()</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">1</span>, i].text(width , height<span class="op">+</span><span class="fl">0.2</span>, <span class="ss">f'</span><span class="sc">{</span><span class="bu">round</span>(p.get_width())<span class="sc">}</span><span class="ss">'</span>, ha <span class="op">=</span> <span class="st">'center'</span>, size <span class="op">=</span> <span class="dv">13</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">""</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">""</span>)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<section id="중립구간---cci--20-20" class="level3">
<h3 class="anchored" data-anchor-id="중립구간---cci--20-20">1) 중립구간 - CCI : (-20, 20)</h3>
<section id="i.-2019" class="level4">
<h4 class="anchored" data-anchor-id="i.-2019">I. 2019</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>clusters_2019_1 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2019</span>, cci_type<span class="op">=</span><span class="dv">1</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-6-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_shap_2019_1, df_tsne_2019_1_1 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2019_1, <span class="dv">2019</span>, <span class="dv">1</span>, t<span class="op">=</span><span class="dv">13</span>, ratio<span class="op">=</span><span class="fl">0.22</span>, xlim<span class="op">=</span><span class="dv">80</span>, ylim<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 53
label 1 &gt; 0.22 군집 번호:  Int64Index([21, 23, 24, 26, 27, 36, 47, 49], dtype='int64', name='Cluster')
데이터의 개수: 4313
종목의 종류: 1024  |  날짜의 종류:  246</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="ii.-2020" class="level4">
<h4 class="anchored" data-anchor-id="ii.-2020">II. 2020</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>clusters_2020_1 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2020</span>, cci_type<span class="op">=</span><span class="dv">1</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_shap_2020_1, df_tsne_2020_1_1 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2020_1, <span class="dv">2020</span>, <span class="dv">1</span>, t<span class="op">=</span><span class="dv">13</span>, ratio<span class="op">=</span><span class="fl">0.29</span>, xlim<span class="op">=</span><span class="dv">80</span>, ylim<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 53
label 1 &gt; 0.29 군집 번호:  Int64Index([24, 26, 27, 30, 38, 40, 41, 42, 43], dtype='int64', name='Cluster')
데이터의 개수: 4827
종목의 종류: 1306  |  날짜의 종류:  247</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-9-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="iii.-2021" class="level4">
<h4 class="anchored" data-anchor-id="iii.-2021">III. 2021</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>clusters_2021_1 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2021</span>, cci_type<span class="op">=</span><span class="dv">1</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_shap_2021_1, df_tsne_2021_1_1 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2021_1, <span class="dv">2021</span>, <span class="dv">1</span>, t<span class="op">=</span><span class="dv">13</span>, ratio<span class="op">=</span><span class="fl">0.207</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 51
label 1 &gt; 0.207 군집 번호:  Int64Index([3, 4, 13, 18, 21, 22, 24, 25], dtype='int64', name='Cluster')
데이터의 개수: 4237
종목의 종류: 1092  |  날짜의 종류:  237</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="중립구간-상승-추세-군집-해석" class="level4">
<h4 class="anchored" data-anchor-id="중립구간-상승-추세-군집-해석">🌟 중립구간 상승 추세 군집 해석</h4>
<ol type="1">
<li>연도별 빈도수 상위 주 &amp; 날짜</li>
</ol>
<div class="cell" data-execution_count="203">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>lst_data <span class="op">=</span> [df_tsne_2019_1_1, df_tsne_2020_1_1, df_tsne_2021_1_1]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>visualization_week(data_list<span class="op">=</span>lst_data, week_num<span class="op">=</span><span class="dv">5</span>, day_num<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>중립구간</code>에서 상승 추세 군집 데이터의 날짜 빈도수는 <strong>2019년도</strong>는 <strong>8월 3주차</strong>, <strong>2020년도</strong>는 <strong>4월 1주차</strong>, <strong>2021년도</strong>는 <strong>2월 1주차</strong>가 가장 높게 나왔습니다. 그 중에서도 가장 큰 날짜 빈도 차이를 보인 연도는 <strong>2020년</strong>이었습니다.</p>
<p><br></p>
<ol start="2" type="1">
<li>연도별 상위 날짜의 개별 종목 차트 확인</li>
</ol>
<ul>
<li>연도별 상위 날짜의 랜덤 종목코드 데이터프레임 생성</li>
</ul>
<p>상위 날짜들을 바꿔가며 실행하고, 랜덤으로 나오는 종목코드들의 개별 종목 차트를 확인합니다.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-hide</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>df_tsne_2019_1_1[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2019_1_1[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>df_tsne_2020_1_1[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2020_1_1[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>df_tsne_2021_1_1[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2021_1_1[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> df_tsne_2019_1_1.loc[df_tsne_2019_1_1[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2019-08-20'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df_tsne_2020_1_1.loc[df_tsne_2020_1_1[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2020-04-01'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>df3 <span class="op">=</span> df_tsne_2021_1_1.loc[df_tsne_2021_1_1[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2021-02-01'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>pd.concat([df1, df2, df3], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Date</th>
      <th>Code</th>
      <th>Date</th>
      <th>Code</th>
      <th>Date</th>
      <th>Code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-08-20</td>
      <td>007540</td>
      <td>2020-04-01</td>
      <td>160980</td>
      <td>2021-02-01</td>
      <td>023800</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-08-20</td>
      <td>047400</td>
      <td>2020-04-01</td>
      <td>119850</td>
      <td>2021-02-01</td>
      <td>033240</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-08-20</td>
      <td>010820</td>
      <td>2020-04-01</td>
      <td>041190</td>
      <td>2021-02-01</td>
      <td>038110</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-08-20</td>
      <td>020120</td>
      <td>2020-04-01</td>
      <td>024110</td>
      <td>2021-02-01</td>
      <td>039020</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-08-20</td>
      <td>081150</td>
      <td>2020-04-01</td>
      <td>002900</td>
      <td>2021-02-01</td>
      <td>001810</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<ul>
<li>차트 확인 예시</li>
</ul>
<p><strong>2019년 8월 20일</strong><br>
<img src="08.cluster_filtering_files/figure-html/cd92919d-0e2f-4218-a266-f12d30f9b8ff-2-5810adda-e94a-40e3-ba40-aa2999b0bdc0.png" title="종목코드: 082800" class="img-fluid" alt="image.png"></p>
<p><strong>2020년 4월 1일</strong><br>
<img src="08.cluster_filtering_files/figure-html/cd92919d-0e2f-4218-a266-f12d30f9b8ff-1-1d44cba8-eb4c-40ab-824f-595ebe93dd73.png" title="종목코드: 089890" class="img-fluid" alt="image.png"></p>
<p><strong>2021년 2월 1일</strong><br>
<img src="08.cluster_filtering_files/figure-html/cd92919d-0e2f-4218-a266-f12d30f9b8ff-3-e6f731bb-780b-438f-a325-bcd2c8e8b713.png" title="종목코드: 033240" class="img-fluid" alt="image.png"></p>
<p>여러개의 차트 확인을 해보았을 때, 가장 큰 날짜 편중을 보였던 <strong>2020년도</strong>는 <strong>차트의 패턴이 가장 일정</strong>하게 나타났으며, 2019,2021년도는 2020년도 만큼 일정한 패턴을 보이지는 않았습니다. 하지만 세 연도에서 공통적으로 나오는 패턴이 존재했습니다. 해당 패턴을 분석해보았을 때, 위의 세 사진과 같이, <code>하락 추세에서 상승 추세로 전환</code>되는 <code>V자</code> 형태였으며, 그 중에서도 <code>기준일(D0)[회색 선]이 오른쪽에 위치</code>한다는 공통점이 있었습니다.</p>
<p><br> <br></p>
</section>
</section>
<section id="과열구간과매수구간---cci-100" class="level3">
<h3 class="anchored" data-anchor-id="과열구간과매수구간---cci-100">2) 과열구간/과매수구간 - CCI : (100, ∞ )</h3>
<section id="i.-2019-1" class="level4">
<h4 class="anchored" data-anchor-id="i.-2019-1">I. 2019</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>clusters_2019_2 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2019</span>, cci_type<span class="op">=</span><span class="dv">2</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_shap_2019_2, df_tsne_2019_1_2 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2019_2, <span class="dv">2019</span>, <span class="dv">2</span>, t<span class="op">=</span><span class="dv">12</span>, ratio<span class="op">=</span><span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 48
label 1 &gt; 0.25 군집 번호:  Int64Index([8, 16, 17, 21, 30], dtype='int64', name='Cluster')
데이터의 개수: 5016
종목의 종류: 1023  |  날짜의 종류:  246</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="ii.-2020-1" class="level4">
<h4 class="anchored" data-anchor-id="ii.-2020-1">II. 2020</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>clusters_2020_2 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2020</span>, cci_type<span class="op">=</span><span class="dv">2</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-16-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_shap_2020_2, df_tsne_2020_1_2 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2020_2, <span class="dv">2020</span>, <span class="dv">2</span>, t<span class="op">=</span><span class="dv">11</span>, ratio<span class="op">=</span><span class="fl">0.31</span>, xlim<span class="op">=</span><span class="dv">65</span>, ylim<span class="op">=</span><span class="dv">65</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 55
label 1 &gt; 0.31 군집 번호:  Int64Index([1, 14, 16, 22, 36, 39], dtype='int64', name='Cluster')
데이터의 개수: 5457
종목의 종류: 1190  |  날짜의 종류:  247</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-17-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="iii.-2021-1" class="level4">
<h4 class="anchored" data-anchor-id="iii.-2021-1">III. 2021</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>clusters_2021_2 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2021</span>, cci_type<span class="op">=</span><span class="dv">2</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-18-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_shap_2021_2, df_tsne_2021_1_2 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2021_2, <span class="dv">2021</span>, <span class="dv">2</span>, t<span class="op">=</span><span class="dv">12</span>, ratio<span class="op">=</span><span class="fl">0.268</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 52
label 1 &gt; 0.268 군집 번호:  Int64Index([5, 9, 14, 16, 31, 32, 43, 51], dtype='int64', name='Cluster')
데이터의 개수: 5632
종목의 종류: 1110  |  날짜의 종류:  237</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-19-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="과매수구간-상승-추세-군집-해석" class="level4">
<h4 class="anchored" data-anchor-id="과매수구간-상승-추세-군집-해석">🌟 과매수구간 상승 추세 군집 해석</h4>
<ol type="1">
<li>연도별 빈도수 상위 주 &amp; 날짜</li>
</ol>
<div class="cell" data-execution_count="204">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>lst_data <span class="op">=</span> [df_tsne_2019_1_2, df_tsne_2020_1_2, df_tsne_2021_1_2]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>visualization_week(data_list<span class="op">=</span>lst_data, week_num<span class="op">=</span><span class="dv">5</span>, day_num<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>과매수구간</code>에서 빈도수가 높은 날짜는 <strong>2019년 1월 4주차</strong>, <strong>2020년 4월 3주차</strong>, <strong>2021년 1월 3주차</strong>임을 알 수 있 습니다. 다른 CCI 구간에 비해 상위 빈도수의 크기 차이가 많지 않았습니다. 가장 높은 날짜 빈도 차이를 보이는 연도는 중립구간과 마찬가지로 <strong>2020년도</strong>였습니다.</p>
<p><br></p>
<ol start="2" type="1">
<li>연도별 상위 날짜의 개별 종목 차트 확인</li>
</ol>
<ul>
<li>연도별 상위 날짜의 랜덤 종목코드 데이터프레임 생성</li>
</ul>
<p>상위 날짜들을 바꿔가며 실행하고, 랜덤으로 나오는 종목코드들의 개별 종목 차트를 확인합니다.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-hide</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>df_tsne_2019_1_2[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2019_1_2[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>df_tsne_2020_1_2[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2020_1_2[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>df_tsne_2021_1_2[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2021_1_2[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> df_tsne_2019_1_2.loc[df_tsne_2019_1_2[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2019-01-17'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df_tsne_2020_1_2.loc[df_tsne_2020_1_2[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2020-04-17'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>df3 <span class="op">=</span> df_tsne_2021_1_2.loc[df_tsne_2021_1_2[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2021-01-20'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>pd.concat([df1, df2, df3], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Date</th>
      <th>Code</th>
      <th>Date</th>
      <th>Code</th>
      <th>Date</th>
      <th>Code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-01-17</td>
      <td>042370</td>
      <td>2020-04-17</td>
      <td>008250</td>
      <td>2021-01-20</td>
      <td>095340</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-01-17</td>
      <td>187220</td>
      <td>2020-04-17</td>
      <td>017550</td>
      <td>2021-01-20</td>
      <td>025880</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-01-17</td>
      <td>024900</td>
      <td>2020-04-17</td>
      <td>035620</td>
      <td>2021-01-20</td>
      <td>011500</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-01-17</td>
      <td>106240</td>
      <td>2020-04-17</td>
      <td>011370</td>
      <td>2021-01-20</td>
      <td>010690</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-01-17</td>
      <td>007390</td>
      <td>2020-04-17</td>
      <td>048430</td>
      <td>2021-01-20</td>
      <td>000270</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<ul>
<li>차트 확인 예시</li>
</ul>
<p><strong>2019년 1월 17일</strong><br>
<img src="08.cluster_filtering_files/figure-html/0a1b5acb-53c0-4755-ad65-ab8a5df59427-1-37f326f7-059b-4921-8558-cef135b24ee1.png" title="종목코드: 187220" class="img-fluid" alt="image.png"></p>
<p><strong>2020년 4월 17일</strong><br>
<img src="08.cluster_filtering_files/figure-html/0a1b5acb-53c0-4755-ad65-ab8a5df59427-3-fd18d37b-2edd-45de-8645-14c7ed11280c.png" title="종목코드: 035620" class="img-fluid" alt="image.png"></p>
<p><strong>2021년 1월 20일</strong><br>
<img src="08.cluster_filtering_files/figure-html/0a1b5acb-53c0-4755-ad65-ab8a5df59427-2-93e05fb5-8bf0-4904-befc-71203049da61.png" title="종목코드: 010690" class="img-fluid" alt="image.png"></p>
<p><code>과매수구간</code>은 20일 이동평균선의 위에 극단적으로 떨어져있는 데이터들이므로, 기준일(D0)[회색 선]이 상승추세에서의 중간 ~ 끝 무렵에 위치하였습니다. 다른 CCI 구간보다 패턴이 가장 불규칙적이었지만, <code>하락추세에서 상승추세로 전환되는 V자 형태에서 상승추세 끝무렵에 위치</code>하는 공통된 패턴을 <strong>일부 데이터</strong>에서 검출할 수 있었습니다.</p>
<p><br> <br></p>
</section>
</section>
<section id="침체구간과매도구간---cci----100" class="level3">
<h3 class="anchored" data-anchor-id="침체구간과매도구간---cci----100">3) 침체구간/과매도구간 - CCI : (- ∞ ,-100)</h3>
<section id="i.-2019-2" class="level4">
<h4 class="anchored" data-anchor-id="i.-2019-2">I. 2019</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>clusters_2019_3 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2019</span>, cci_type<span class="op">=</span><span class="dv">3</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-22-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_shap_2019_3, df_tsne_2019_1_3 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2019_3, <span class="dv">2019</span>, <span class="dv">3</span>, t<span class="op">=</span><span class="dv">10</span>, ratio<span class="op">=</span><span class="fl">0.365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 58
label 1 &gt; 0.365 군집 번호:  Int64Index([1, 2, 25, 26, 50], dtype='int64', name='Cluster')
데이터의 개수: 3959
종목의 종류: 994  |  날짜의 종류:  222</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-23-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="ii.-2020-2" class="level4">
<h4 class="anchored" data-anchor-id="ii.-2020-2">II. 2020</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>clusters_2020_3 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2020</span>, cci_type<span class="op">=</span><span class="dv">3</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-24-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df_shap_2020_3, df_tsne_2020_1_3 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2020_3, <span class="dv">2020</span>, <span class="dv">3</span>, t<span class="op">=</span><span class="dv">12</span>, ratio<span class="op">=</span><span class="fl">0.5</span>, xlim<span class="op">=</span><span class="dv">80</span>, ylim<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 47
label 1 &gt; 0.5 군집 번호:  Int64Index([2, 3, 15, 28, 37], dtype='int64', name='Cluster')
데이터의 개수: 3874
종목의 종류: 1356  |  날짜의 종류:  78</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-25-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="iii.-2021-2" class="level4">
<h4 class="anchored" data-anchor-id="iii.-2021-2">III. 2021</h4>
<ul>
<li>덴드로그램</li>
</ul>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>clusters_2021_3 <span class="op">=</span> hierarchical_clustering_plot(method<span class="op">=</span><span class="st">'average'</span>, year<span class="op">=</span><span class="dv">2021</span>, cci_type<span class="op">=</span><span class="dv">3</span>, dendrogram<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linkage complete</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-26-output-2.png" class="img-fluid"></p>
</div>
</div>
<ul>
<li>계층적 클러스터링 &amp; 상승 추세 군집 선택</li>
</ul>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df_shap_2021_3, df_tsne_2021_1_3 <span class="op">=</span> fcluster_plot_and_filtering(clusters_2021_3, <span class="dv">2021</span>, <span class="dv">3</span>, t<span class="op">=</span><span class="dv">10</span>, ratio<span class="op">=</span><span class="fl">0.35</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>군집의 개수: 53
label 1 &gt; 0.35 군집 번호:  Int64Index([5, 7, 10, 15], dtype='int64', name='Cluster')
데이터의 개수: 4174
종목의 종류: 1163  |  날짜의 종류:  230</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-27-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><br></p>
</section>
<section id="과매도구간-상승-추세-군집-해석" class="level4">
<h4 class="anchored" data-anchor-id="과매도구간-상승-추세-군집-해석">🌟 과매도구간 상승 추세 군집 해석</h4>
<ol type="1">
<li>연도별 빈도수 상위 주 &amp; 날짜</li>
</ol>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>lst_data <span class="op">=</span> [df_tsne_2019_1_3, df_tsne_2020_1_3, df_tsne_2021_1_3]</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>visualization_week(data_list<span class="op">=</span>lst_data, week_num<span class="op">=</span><span class="dv">5</span>, day_num<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="08.cluster_filtering_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>과매도구간</code>의 빈도수 상위 날짜는 <strong>2019년 8월 1주차</strong>, <strong>2020년 3월 4주차</strong>, <strong>2021년 10월 1주차</strong>였습니다. CCI 구간 중 유일하게 모든 연도에서 높은 날짜 빈도 차이를 보였습니다.</p>
<p><br></p>
<ol start="2" type="1">
<li>연도별 상위 날짜의 개별 종목 차트 확인</li>
</ol>
<ul>
<li>연도별 상위 날짜의 랜덤 종목코드 데이터프레임 생성</li>
</ul>
<p>상위 날짜들을 바꿔가며 실행하고, 랜덤으로 나오는 종목코드들의 개별 종목 차트를 확인합니다.</p>
<div class="cell" data-execution_count="206">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-hide</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>df_tsne_2019_1_3[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2019_1_3[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>df_tsne_2020_1_3[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2020_1_3[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>df_tsne_2021_1_3[<span class="st">'Date'</span>] <span class="op">=</span> df_tsne_2021_1_3[<span class="st">'Date'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>df1 <span class="op">=</span> df_tsne_2019_1_3.loc[df_tsne_2019_1_3[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2019-08-06'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df_tsne_2020_1_3.loc[df_tsne_2020_1_3[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2020-03-19'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>df3 <span class="op">=</span> df_tsne_2021_1_3.loc[df_tsne_2021_1_3[<span class="st">'Date'</span>] <span class="op">==</span> <span class="st">'2021-10-07'</span>, [<span class="st">'Date'</span>, <span class="st">'Code'</span>]].sample(<span class="dv">5</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>pd.concat([df1, df2, df3], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="206">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Date</th>
      <th>Code</th>
      <th>Date</th>
      <th>Code</th>
      <th>Date</th>
      <th>Code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2019-08-06</td>
      <td>033100</td>
      <td>2020-03-19</td>
      <td>126880</td>
      <td>2021-10-07</td>
      <td>028300</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019-08-06</td>
      <td>060480</td>
      <td>2020-03-19</td>
      <td>000850</td>
      <td>2021-10-07</td>
      <td>088130</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2019-08-06</td>
      <td>014190</td>
      <td>2020-03-19</td>
      <td>170920</td>
      <td>2021-10-07</td>
      <td>042110</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2019-08-06</td>
      <td>123860</td>
      <td>2020-03-19</td>
      <td>189860</td>
      <td>2021-10-07</td>
      <td>081000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2019-08-06</td>
      <td>067990</td>
      <td>2020-03-19</td>
      <td>079160</td>
      <td>2021-10-07</td>
      <td>002690</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<ul>
<li>차트 확인 예시</li>
</ul>
<p><strong>2019년 8월 6일</strong><br>
<img src="08.cluster_filtering_files/figure-html/b7a7363a-ec9b-4fea-b73b-21b6627cd9b1-3-e5aad13f-b5ab-4589-84b6-3cb023521430.png" title="종목코드: 033100" class="img-fluid" alt="image.png"></p>
<p><strong>2020년 3월 19일</strong><br>
<img src="08.cluster_filtering_files/figure-html/b7a7363a-ec9b-4fea-b73b-21b6627cd9b1-2-6ce4c3be-d169-4484-9d60-275e8fa2aa1b.png" title="종목코드: 126880" class="img-fluid" alt="image.png"></p>
<p><strong>2021년 10월 17일</strong><br>
<img src="08.cluster_filtering_files/figure-html/b7a7363a-ec9b-4fea-b73b-21b6627cd9b1-1-08ea2063-05eb-4861-b19a-9e6cb11ca11a.png" title="종목코드: 088130" class="img-fluid" alt="image.png"></p>
<p>위의 사진과 같이, 모든 연도에서 비슷한 패턴을 보였습니다. <code>하락추세에서 상승추세로 전환되는 V자 형태</code>의 공통된 패턴에서, <code>기준일(D0)[회색 선]이 꼭지점 근처에 위치</code>하였습니다.</p>
<p><br> <br></p>
</section>
</section>
</section>
<section id="정리" class="level2">
<h2 class="anchored" data-anchor-id="정리">(2) 정리</h2>
<p>지금까지 <code>분류 머신러닝 모델학습</code>, <code>SHAP 표준화</code>, <code>클러스터링 분석</code>의 과정을 거쳐 <code>10일 간의 주가 시계열 데이터로</code>부터 주가 <code>상승 추세 패턴</code>을 검출하였습니다.</p>
<p>CCI 구간 별, 연도 별로 나누어 연구를 진행하였는데,</p>
<p>1) <strong>CCI 구간</strong> 별 공통적으로 나타나는 패턴은 <strong>하락추세에서 상승추세로 전환되는 V자 상승반전형 패턴</strong>이었으며, 기준일(D0)의 위치가 CCI 구간에 따라 다르게 나타났습니다. 특히나 <code>과매도구간</code>에서의 패턴이 다른 구간에 비해 가장 정확하고 유사한 것을 확인할 수 있었습니다.</p>
<p>2) 모든 CCI 구간을 통틀어 <strong>2019, 2020, 2021년도</strong> 중 높은 빈도로 나타나는 날짜의 편중이 가장 큰 연도는 <strong>2020년</strong>이었으며, 2020년도에서 패턴의 모양 또한 가장 유사하게 나타났습니다.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>